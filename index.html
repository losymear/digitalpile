<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</title>
    <style>
        /* ç®€å•çš„ CSS æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007aff;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .data-status {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 30px;
        }
        .menu-list {
            list-style: none;
            padding: 0;
        }
        .menu-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .menu-item:hover {
            background-color: #e5e5e5;
        }
        .menu-item-title {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        .menu-item-detail {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        .current-view {
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰åŠŸèƒ½é¡µï¼Œåªæ˜¾ç¤ºèœå• */
            padding-top: 20px;
        }
        .current-view.active {
            display: block;
        }
        input[type="number"], button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #005bb5;
        }
        .result-box {
            background-color: #f0f8ff;
            border: 1px solid #cfe2ff;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .result-title {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .btn-red {
            background-color: #ff3b30;
        }
        .btn-red:hover:not(:disabled) {
            background-color: #cc2d26;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</h1>
        <div class="data-status" id="data-status">æ•°æ®: ç¼ºå¤±</div>

        <div id="menu-page" class="current-view active">
            <ul class="menu-list">
                <li class="menu-item" onclick="handleMenuSelect(0)">
                    <div class="menu-item-title">ğŸ§  1. å•æ¬¡éšæœºè®­ç»ƒ</div>
                    <div class="menu-item-detail">éšæœºä¸€ä¸ªæ•°å­—ï¼Œç¡®è®¤åæ˜¾ç¤ºç¼–ç </div>
                </li>
                <li class="menu-item" onclick="handleMenuSelect(1)">
                    <div class="menu-item-title">ğŸ”¢ 2. å¤šé‡æ•°å­—è®°å¿†</div>
                    <div class="menu-item-detail">è¾“å…¥æ•°é‡ Nï¼Œéšæœº N ä¸ªæ•°å­—ç»„è¿›è¡Œè®°å¿†</div>
                </li>
                <li class="menu-item" onclick="handleMenuSelect(2)">
                    <div class="menu-item-title">ğŸ” 3. æŸ¥è¯¢æ¡©å­</div>
                    <div class="menu-item-detail">è¾“å…¥æ•°å­—ï¼Œç«‹å³æ˜¾ç¤ºå¯¹åº”ç¼–ç </div>
                </li>
            </ul>
        </div>

        <div id="input-page" class="current-view">
            <div class="result-title" id="input-page-title"></div>
            <input type="number" id="input-field" placeholder="" oninput="validateInput()">
            <button id="input-submit-btn" onclick="handleInputSubmit()">ç¡®å®š</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="result-page" class="current-view">
            <div class="result-title" id="result-page-title"></div>
            <div class="result-box" id="result-page-content"></div>
            <button id="result-next-btn" class="btn-red" onclick="handleResultNext()">ç»§ç»­æ­¤é¡¹æ“ä½œ</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        // ======================================================
        // Web å®ç° JavaScript é€»è¾‘
        // ======================================================

        // ğŸ¯ æ‚¨çš„ GitHub Raw JSON URL
        const JSON_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/1000code.json";
        // ğŸ’¾ æœ¬åœ°ç¼“å­˜çš„ Storage Key
        const CACHE_KEY = "1000code_cache";

        let number_encodings = {};
        const MIN_NUM = 100;
        const MAX_NUM = 999;
        let currentPageType = ""; // ç”¨äºè®°å½•å½“å‰è¾“å…¥é¡µæ˜¯ 'multi' è¿˜æ˜¯ 'query'
        let nextActionCallback = null; // ç”¨äºç»“æœé¡µçš„â€œç»§ç»­æ­¤é¡¹æ“ä½œâ€å›è°ƒ

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const menuPage = document.getElementById('menu-page');
        const inputPage = document.getElementById('input-page');
        const resultPage = document.getElementById('result-page');
        const dataStatus = document.getElementById('data-status');
        const mainTitle = document.getElementById('main-title');

        const inputPageTitle = document.getElementById('input-page-title');
        const inputField = document.getElementById('input-field');
        const inputSubmitBtn = document.getElementById('input-submit-btn');

        const resultPageTitle = document.getElementById('result-page-title');
        const resultPageContent = document.getElementById('result-page-content');
        const resultNextBtn = document.getElementById('result-next-btn');

        // --- æ ¸å¿ƒè¾…åŠ©å‡½æ•° (é€‚åº” Web) ---

        function toast(message) {
            // ç®€å•çš„ Web Toast æç¤ºï¼ˆè¿™é‡Œä½¿ç”¨ alert æ›¿ä»£ï¼Œå®é™…åº”ç”¨ä¸­å¯ç”¨è‡ªå®šä¹‰çš„ Toast ç»„ä»¶ï¼‰
            console.log("Toast:", message);
            // alert(message); // é¿å…é¢‘ç¹å¼¹å‡ºï¼Œä»…åœ¨å…³é”®é”™è¯¯æ—¶ä½¿ç”¨
        }

        function generateRandomNumber() {
            const randomNumber = Math.floor(Math.random() * (MAX_NUM - MIN_NUM + 1)) + MIN_NUM;
            return String(randomNumber);
        }

        function getEncoding(numStr) {
            return number_encodings[numStr] || `[${numStr} ç¼–ç ç¼ºå¤±!]`;
        }

        // --- ç•Œé¢åˆ‡æ¢é€»è¾‘ ---

        function hideAllViews() {
            menuPage.classList.remove('active');
            inputPage.classList.remove('active');
            resultPage.classList.remove('active');
        }

        function showMenuUI() {
            hideAllViews();
            menuPage.classList.add('active');
            // æ›´æ–°ä¸»æ ‡é¢˜çš„æ•°æ®çŠ¶æ€
            const statusText = Object.keys(number_encodings).length ? "å·²åŠ è½½" : "ç¼ºå¤±";
            mainTitle.textContent = `æ•°å­—æ¡©è®°å¿†è®­ç»ƒ`;
            dataStatus.textContent = `æ•°æ®: ${statusText}`;
        }

        /**
         * ç›¸å½“äº JSBox çš„ showInputPage
         */
        function showInputPage(type) {
            currentPageType = type;
            hideAllViews();
            inputPage.classList.add('active');

            const isMulti = type === "multi";
            const pageTitle = isMulti ? "è¾“å…¥å¤šé‡è®°å¿†æ•°é‡ N" : "è¾“å…¥æŸ¥è¯¢æ•°å­—";
            const placeholder = isMulti ? "è¯·è¾“å…¥æ•°é‡ N (1-20)" : `è¯·è¾“å…¥ ${MIN_NUM} åˆ° ${MAX_NUM} çš„æ•°å­—`;

            inputPageTitle.textContent = pageTitle;
            inputField.placeholder = placeholder;
            inputField.value = "";
            inputField.setAttribute('min', isMulti ? 1 : MIN_NUM);
            inputField.setAttribute('max', isMulti ? 20 : MAX_NUM);
            inputField.focus();
            validateInput(); // åˆå§‹ç¦ç”¨æŒ‰é’®
        }
        
        function validateInput() {
            const input = inputField.value.trim();
            inputSubmitBtn.disabled = input === "";
        }

        /**
         * ç›¸å½“äº JSBox çš„ showResultUI
         */
        function showResultUI(title, message, nextAction) {
            nextActionCallback = nextAction;
            hideAllViews();
            resultPage.classList.add('active');

            resultPageTitle.textContent = title;
            resultPageContent.textContent = message;

            if (nextAction) {
                resultNextBtn.textContent = "ç»§ç»­æ­¤é¡¹æ“ä½œ";
                resultNextBtn.style.display = 'block';
                resultNextBtn.classList.add('btn-red');
            } else {
                resultNextBtn.style.display = 'none';
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å®ç° (é€‚åº” Web) ---

        function drillRandomNumber() {
            if (!Object.keys(number_encodings).length) {
                alert("âš ï¸ é”™è¯¯: æ•°æ®æœªåŠ è½½ï¼Œè¯·ç­‰å¾…æ•°æ®ç¼“å­˜æˆ–æ£€æŸ¥ç½‘ç»œã€‚");
                return;
            }

            const targetNumber = generateRandomNumber();
            const correctAnswer = getEncoding(targetNumber);

            const userConfirmed = confirm(`ğŸ§  éšæœºæ•°å­—è®­ç»ƒ\n\nè¯·é»˜æƒ³æ•°å­— ${targetNumber} å¯¹åº”çš„ç¼–ç ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ\n\nç‚¹å‡»â€œç¡®å®šâ€æŸ¥çœ‹ç¼–ç ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€è¿”å›èœå•ã€‚`);

            if (userConfirmed) {
                showResultUI(`âœ… ${targetNumber} çš„ç¼–ç `,
                    `æ•°å­—: ${targetNumber}\n\nç¼–ç : ${correctAnswer}`,
                    drillRandomNumber);
            } else {
                showMenuUI();
            }
        }

        function drillMultipleNumbers(N) {
            const N_val = parseInt(N);

            const numbers = new Set();
            while (numbers.size < N_val) {
                numbers.add(generateRandomNumber());
            }
            const numberList = Array.from(numbers);

            const formattedList = numberList.map(numStr => {
                const encoding = getEncoding(numStr);
                return `${numStr}: ${encoding}`;
            }).join('\n');

            const plainNumberList = numberList.join(', ');

            const userConfirmed = confirm(`ğŸ§  ${N_val} ä¸ªæ•°å­—éšæœºè®­ç»ƒ\n\nè¯·å°è¯•è”æƒ³å¹¶è®°å¿†è¿™ç»„æ•°å­—ï¼š\n**${plainNumberList}**\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿ\n\nç‚¹å‡»â€œç¡®å®šâ€æŸ¥çœ‹ç­”æ¡ˆï¼Œç‚¹å‡»â€œå–æ¶ˆâ€è¿”å›èœå•ã€‚`);

            if (userConfirmed) {
                showResultUI("âœ… ç¼–ç ç­”æ¡ˆ",
                    `**æ•°å­—åˆ—è¡¨:**\n${formattedList}`,
                    () => showInputPage("multi") // ä¸‹ä¸€æ­¥å›åˆ°å¤šé‡è®°å¿†çš„è¾“å…¥é¡µ
                );
            } else {
                showMenuUI();
            }
        }

        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---

        function handleMenuSelect(index) {
            if (!Object.keys(number_encodings).length) {
                alert("âš ï¸ é”™è¯¯: æ•°æ®æœªåŠ è½½ï¼Œè¯·ç­‰å¾…æ•°æ®ç¼“å­˜æˆ–æ£€æŸ¥ç½‘ç»œã€‚");
                return;
            }
            switch (index) {
                case 0:
                    drillRandomNumber();
                    break;
                case 1:
                    showInputPage("multi");
                    break;
                case 2:
                    showInputPage("query");
                    break;
            }
        }

        function handleInputSubmit() {
            const input = inputField.value.trim();

            if (input === "") {
                toast("è¾“å…¥ä¸èƒ½ä¸ºç©º");
                return;
            }

            if (currentPageType === "multi") {
                const N = parseInt(input);
                if (N > 0 && N <= 20) {
                    drillMultipleNumbers(N);
                } else {
                    alert("é”™è¯¯: è¯·è¾“å…¥ 1 åˆ° 20 ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ã€‚");
                    showInputPage("multi");
                }
            } else if (currentPageType === "query") {
                const numStr = input;
                const num = parseInt(numStr);
                if (num >= MIN_NUM && num <= MAX_NUM) {
                    const encoding = getEncoding(numStr);
                    showResultUI(`ğŸ” ${numStr} å¯¹åº”çš„ç¼–ç `,
                        `æ•°å­—: ${numStr}\n\nç¼–ç : ${encoding}`,
                        () => showInputPage("query") // ä¸‹ä¸€æ­¥å›åˆ°æŸ¥è¯¢è¾“å…¥é¡µ
                    );
                } else {
                    alert(`âš ï¸ æ•°å­—é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„ ${MIN_NUM} åˆ° ${MAX_NUM} çš„æ•°å­—ã€‚`);
                    showInputPage("query");
                }
            }
        }

        function handleResultNext() {
            if (nextActionCallback) {
                nextActionCallback();
            } else {
                showMenuUI();
            }
        }

        // --- æ ¸å¿ƒåŠ è½½ä¸æ›´æ–°é€»è¾‘ (é€‚åº” Web) ---

        function loadFromCache() {
            const jsonStr = localStorage.getItem(CACHE_KEY);
            if (jsonStr) {
                try {
                    number_encodings = JSON.parse(jsonStr);
                    toast("ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®ã€‚");
                    return true;
                } catch (e) {
                    console.error("è§£ææœ¬åœ°ç¼“å­˜å¤±è´¥:", e);
                    localStorage.removeItem(CACHE_KEY);
                    return false;
                }
            }
            return false;
        }

        async function updateFromRemote(isInitialLoad) {
            if (isInitialLoad) {
                dataStatus.textContent = "æ•°æ®: æ­£åœ¨åŠ è½½...";
            }

            try {
                const response = await fetch(JSON_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const newEncodings = await response.json();

                if (JSON.stringify(newEncodings) !== JSON.stringify(number_encodings)) {
                    number_encodings = newEncodings;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(newEncodings));
                    toast("æ•°æ®å·²æ›´æ–°å¹¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ã€‚");
                    dataStatus.textContent = "æ•°æ®: å·²åŠ è½½";
                } else {
                    if (!isInitialLoad) {
                        toast("æ•°æ®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚");
                    }
                }
                return true;

            } catch (error) {
                console.error("åŠ è½½/æ›´æ–°è¿œç¨‹æ•°æ®å¤±è´¥:", error);
                if (isInitialLoad && !Object.keys(number_encodings).length) {
                    alert(`âŒ é¦–æ¬¡åŠ è½½å¤±è´¥: æ— æ³•ä» GitHub åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œ URLã€‚\n\né”™è¯¯ä¿¡æ¯: ${error.message}`);
                    dataStatus.textContent = "æ•°æ®: ç¼ºå¤±";
                } else if (!isInitialLoad) {
                    toast("ç½‘ç»œä¸ä½³ï¼Œæœªèƒ½æ›´æ–°æ•°æ®ã€‚");
                }
                return false;
            }
        }

        // --- è„šæœ¬ä¸»æµç¨‹ ---

        async function init() {
            const cacheLoaded = loadFromCache();

            if (cacheLoaded) {
                showMenuUI();
                await updateFromRemote(false); // å¼‚æ­¥æ›´æ–°
            } else {
                const success = await updateFromRemote(true);
                showMenuUI(); // æ— è®ºæˆåŠŸä¸å¦ï¼Œéƒ½æ˜¾ç¤ºèœå•ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ•°æ®çŠ¶æ€
            }
        }

        // å¯åŠ¨è„šæœ¬
        init();
    </script>
</body>
</html>
