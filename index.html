<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007aff; font-size: 24px; margin-bottom: 20px; text-align: center; }
        .data-status { text-align: center; font-size: 14px; color: #888; margin-bottom: 30px; }
        
        /* èœå•æ ·å¼ */
        .menu-list { list-style: none; padding: 0; }
        .menu-item { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: background-color 0.2s; }
        .menu-item:hover { background-color: #e5e5e5; }
        .menu-item-title { font-weight: bold; font-size: 18px; color: #333; }
        .menu-item-detail { font-size: 14px; color: #888; margin-top: 5px; }
        
        /* è§†å›¾åˆ‡æ¢ */
        .current-view { display: none; padding-top: 20px; }
        .current-view.active { display: block; }
        
        /* è¾“å…¥æ§ä»¶ */
        input[type="number"], input[type="text"], button { padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; width: 100%; box-sizing: border-box; font-size: 16px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group input { margin-bottom: 0; }
        
        /* æŒ‰é’® */
        button { background-color: #007aff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #005bb5; }
        .btn-red { background-color: #ff3b30; }
        .btn-red:hover:not(:disabled) { background-color: #cc2d26; }
        .btn-green { background-color: #34c759; }
        .btn-green:hover:not(:disabled) { background-color: #248a3d; }
        
        /* ç»“æœå±•ç¤º */
        .result-box { background-color: #f0f8ff; border: 1px solid #cfe2ff; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-size: 16px; margin-bottom: 20px; }
        .result-title { font-weight: bold; font-size: 20px; margin-bottom: 10px; }
        
        /* è®¾ç½®æ  */
        .setting-bar { display: none; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .setting-content { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .setting-bar input { text-align: center; padding: 5px; margin-bottom: 0; border: 1px solid #ddd; font-size: 14px; }
        .input-short { width: 50px; }
        .input-medium { width: 70px; }
        .setting-bar label { font-weight: bold; font-size: 14px; }

        /* --- é»˜å†™æµ‹è¯•ä¸“å±æ ·å¼ --- */
        .quiz-card { text-align: center; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 10px; margin-bottom: 20px; }
        .quiz-number { font-size: 60px; font-weight: bold; color: #007aff; display: block; margin: 10px 0; letter-spacing: 2px; }
        .quiz-feedback { padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; display: none; }
        .quiz-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .quiz-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .quiz-info { font-size: 12px; color: #999; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</h1>
        <div class="data-status" id="data-status">æ•°æ®: ç¼ºå¤±</div>

        <div id="menu-page" class="current-view active">
            <ul class="menu-list">
                <li class="menu-item" onclick="showDrillRangeUI()">
                    <div class="menu-item-title">ğŸ§  1. å•æ¬¡éšæœºè®­ç»ƒ</div>
                    <div class="menu-item-detail">çœ‹æ•°å­— -> è„‘æµ·è”æƒ³ -> çœ‹ç­”æ¡ˆæ ¸å¯¹</div>
                </li>
                <li class="menu-item" onclick="showQuizRangeUI()">
                    <div class="menu-item-title">ğŸ“ 2. é»˜å†™æµ‹è¯• (æ–°å¢)</div>
                    <div class="menu-item-detail">çœ‹æ•°å­— -> è¾“å…¥æ–‡å­— -> ç³»ç»Ÿè‡ªåŠ¨åˆ¤åˆ†</div>
                </li>
                <li class="menu-item" onclick="showInputPage('multi')">
                    <div class="menu-item-title">ğŸ”¢ 3. å¤šé‡æ•°å­—è®°å¿†</div>
                    <div class="menu-item-detail">ä¸€æ¬¡æ€§è®°å¿† N ä¸ªæ•°å­—</div>
                </li>
                <li class="menu-item" onclick="showInputPage('query')">
                    <div class="menu-item-title">ğŸ” 4. æŸ¥è¯¢æ¡©å­</div>
                    <div class="menu-item-detail">æŸ¥æ•°å­—å¯¹åº”çš„ç¼–ç </div>
                </li>
            </ul>
        </div>

        <div id="drill-range-page" class="current-view">
            <div class="result-title">éšæœºè®­ç»ƒ - è®¾å®šèŒƒå›´</div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">è¾“å…¥æ•°å­—èŒƒå›´ (å¦‚ 100-999)</div>
            <div class="input-group">
                <input type="number" id="drill-min" placeholder="æœ€å°å€¼" value="100">
                <span style="align-self: center;">-</span>
                <input type="number" id="drill-max" placeholder="æœ€å¤§å€¼" value="999">
            </div>
            <button onclick="handleDrillStart()">å¼€å§‹è®­ç»ƒ</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="quiz-range-page" class="current-view">
            <div class="result-title">é»˜å†™æµ‹è¯• - è®¾å®šèŒƒå›´</div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">è¾“å…¥æ•°å­—èŒƒå›´ï¼Œç³»ç»Ÿå°†éšæœºå‡ºé¢˜</div>
            <div class="input-group">
                <input type="number" id="quiz-min-setup" placeholder="æœ€å°å€¼" value="100">
                <span style="align-self: center;">-</span>
                <input type="number" id="quiz-max-setup" placeholder="æœ€å¤§å€¼" value="999">
            </div>
            <button onclick="handleQuizStart()">å¼€å§‹æµ‹è¯•</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="quiz-working-page" class="current-view">
            <div class="quiz-card">
                <div class="quiz-info">è¯·é»˜å†™ä¸‹æ–¹æ•°å­—å¯¹åº”çš„æ¡©å­</div>
                <span class="quiz-number" id="quiz-question-num">000</span>
                <div class="quiz-info">(èŒƒå›´: <span id="quiz-range-label"></span>)</div>
            </div>

            <div id="quiz-result-box" class="quiz-feedback"></div>

            <input type="text" id="quiz-answer-input" placeholder="è¾“å…¥æ¡©å­ (å¦‚: è®®æ”¿å…)" onkeydown="if(event.key==='Enter') checkQuizAnswer()">
            
            <button id="quiz-submit-btn" onclick="checkQuizAnswer()">æäº¤</button>
            <button id="quiz-next-btn" class="btn-green" style="display:none;" onclick="nextQuizRound()">ä¸‹ä¸€ä¸ª</button>
            <button onclick="showMenuUI()" style="margin-top: 10px; background-color: #666;">é€€å‡ºæµ‹è¯•</button>
        </div>

        <div id="input-page" class="current-view">
            <div class="result-title" id="input-page-title"></div>
            <input type="number" id="input-field" placeholder="" oninput="validateInput()">
            <button id="input-submit-btn" onclick="handleInputSubmit()">ç¡®å®š</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="result-page" class="current-view">
            <div class="result-title" id="result-page-title"></div>
            <div class="result-box" id="result-page-content"></div>
            
            <div id="result-setting-bar" class="setting-bar">
                <div id="setting-multi-content" class="setting-content" style="display:none;">
                    <label>ä¸‹è½®æ•°é‡:</label>
                    <input type="number" id="next-count-input" class="input-short" min="1" max="20" value="5">
                    <span>ä¸ª</span>
                </div>
                <div id="setting-single-content" class="setting-content" style="display:none;">
                    <label>èŒƒå›´:</label>
                    <input type="number" id="next-min-input" class="input-medium" placeholder="Min">
                    <span>-</span>
                    <input type="number" id="next-max-input" class="input-medium" placeholder="Max">
                </div>
            </div>

            <button id="result-view-next-btn" class="btn-green" style="display: none;" onclick="handleViewNext()">æŸ¥çœ‹ä¸‹ä¸€ä¸ª ></button>
            <button id="result-next-btn" class="btn-red" onclick="handleResultNext()">ç»§ç»­æ­¤é¡¹æ“ä½œ</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

    </div>

    <script>
        // ======================================================
        // æ•°æ®ä¸çŠ¶æ€
        // ======================================================
        const JSON_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/1000code.json";
        const CACHE_KEY = "1000code_cache";
        const DEFAULT_MIN = 100;
        const DEFAULT_MAX = 999;
        let number_encodings = {};

        // é¡µé¢å…ƒç´ å¼•ç”¨
        const views = {
            menu: document.getElementById('menu-page'),
            drillRange: document.getElementById('drill-range-page'),
            quizRange: document.getElementById('quiz-range-page'),
            quizWork: document.getElementById('quiz-working-page'),
            input: document.getElementById('input-page'),
            result: document.getElementById('result-page')
        };
        
        // å…¨å±€çŠ¶æ€ (ç”¨äºè®°å½•ä¸Šä¸€æ¬¡çš„èŒƒå›´ï¼Œæ–¹ä¾¿è¿è´¯æ“ä½œ)
        let lastDrillMin = DEFAULT_MIN;
        let lastDrillMax = DEFAULT_MAX;
        let lastQuizMin = DEFAULT_MIN;
        let lastQuizMax = DEFAULT_MAX;
        
        let currentQuizTargetNum = null; // å½“å‰é»˜å†™æµ‹è¯•çš„æ•°å­—
        let currentPageType = ""; 
        let nextActionCallback = null;
        let currentQueryNumber = null;
        let currentMultiCount = 5;

        // ======================================================
        // æ ¸å¿ƒå·¥å…·å‡½æ•°
        // ======================================================
        function toast(message) { console.log(message); }

        function hideAllViews() {
            Object.values(views).forEach(el => el.classList.remove('active'));
            // é‡ç½®ä¸€äº›é€šç”¨çš„å­å…ƒç´ æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('result-setting-bar').style.display = 'none';
        }

        function generateRandomNumber(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return String(Math.floor(Math.random() * (max - min + 1)) + min);
        }

        function getEncoding(numStr) {
            return number_encodings[numStr] || `[ç¼ºå¤±]`;
        }

        function checkDataLoaded() {
            if (!Object.keys(number_encodings).length) {
                alert("âš ï¸ æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                return false;
            }
            return true;
        }

        // ======================================================
        // é¡µé¢è·³è½¬é€»è¾‘
        // ======================================================
        function showMenuUI() {
            hideAllViews();
            views.menu.classList.add('active');
            const statusText = Object.keys(number_encodings).length ? "å·²åŠ è½½" : "ç¼ºå¤±";
            document.getElementById('data-status').textContent = `æ•°æ®: ${statusText}`;
        }

        // 1. å•æ¬¡è®­ç»ƒ - èŒƒå›´é¡µ
        function showDrillRangeUI() {
            if(!checkDataLoaded()) return;
            hideAllViews();
            views.drillRange.classList.add('active');
            document.getElementById('drill-min').value = lastDrillMin;
            document.getElementById('drill-max').value = lastDrillMax;
        }

        // 2. é»˜å†™æµ‹è¯• - èŒƒå›´é¡µ (ç‹¬ç«‹)
        function showQuizRangeUI() {
            if(!checkDataLoaded()) return;
            hideAllViews();
            views.quizRange.classList.add('active');
            document.getElementById('quiz-min-setup').value = lastQuizMin;
            document.getElementById('quiz-max-setup').value = lastQuizMax;
        }

        // 3. é€šç”¨è¾“å…¥é¡µ (å¤šé‡/æŸ¥è¯¢)
        function showInputPage(type) {
            if(!checkDataLoaded()) return;
            currentPageType = type;
            hideAllViews();
            views.input.classList.add('active');
            
            const field = document.getElementById('input-field');
            const title = document.getElementById('input-page-title');
            
            field.value = "";
            field.focus();

            if (type === 'multi') {
                title.textContent = "å¤šé‡è®°å¿† - è¾“å…¥æ•°é‡";
                field.placeholder = "è¯·è¾“å…¥ 1-20";
            } else {
                title.textContent = "æŸ¥è¯¢ç¼–ç  - è¾“å…¥æ•°å­—";
                field.placeholder = "è¯·è¾“å…¥æ•°å­— (00-999)";
            }
            validateInput();
        }

        // ======================================================
        // ä¸šåŠ¡é€»è¾‘ï¼šé»˜å†™æµ‹è¯• (Quiz)
        // ======================================================
        
        function handleQuizStart() {
            const min = parseInt(document.getElementById('quiz-min-setup').value);
            const max = parseInt(document.getElementById('quiz-max-setup').value);
            
            if (isNaN(min) || isNaN(max) || min > max) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„èŒƒå›´");
                return;
            }
            
            // ä¿å­˜çŠ¶æ€
            lastQuizMin = min;
            lastQuizMax = max;
            
            // è¿›å…¥æµ‹è¯•é¡µ
            hideAllViews();
            views.quizWork.classList.add('active');
            nextQuizRound();
        }

        function nextQuizRound() {
            currentQuizTargetNum = generateRandomNumber(lastQuizMin, lastQuizMax);
            
            // UI é‡ç½®
            document.getElementById('quiz-question-num').textContent = currentQuizTargetNum;
            document.getElementById('quiz-range-label').textContent = `${lastQuizMin} - ${lastQuizMax}`;
            
            const input = document.getElementById('quiz-answer-input');
            input.value = "";
            input.disabled = false;
            input.focus();
            
            const feedback = document.getElementById('quiz-result-box');
            feedback.style.display = 'none';
            feedback.className = 'quiz-feedback'; // remove colors
            
            document.getElementById('quiz-submit-btn').style.display = 'block';
            document.getElementById('quiz-next-btn').style.display = 'none';
        }

        function checkQuizAnswer() {
            const inputEl = document.getElementById('quiz-answer-input');
            const val = inputEl.value.trim();
            if(!val) return;
            
            const correctString = getEncoding(currentQuizTargetNum); // æ¯”å¦‚ "æ˜“ä¸­å¤©, è®®æ”¿å…"
            
            // æ¨¡ç³ŠåŒ¹é…ï¼šåˆ†å‰²é€—å·ï¼ˆä¸­è‹±æ–‡ï¼‰æˆ–ç©ºæ ¼
            // æ¯”å¦‚æ ‡å‡†ç­”æ¡ˆæ˜¯ "A, B"ï¼Œç”¨æˆ·è¾“å…¥ "A" æˆ– "B" éƒ½ç®—å¯¹
            const answers = correctString.split(/,|ï¼Œ|\s+/).map(s => s.trim()).filter(s => s);
            const isCorrect = answers.includes(val);
            
            const feedback = document.getElementById('quiz-result-box');
            feedback.style.display = 'block';
            
            if (isCorrect) {
                feedback.className = 'quiz-feedback quiz-correct';
                feedback.innerHTML = `<strong>ğŸ‰ å›ç­”æ­£ç¡®ï¼</strong><br>ä½ çš„ç­”æ¡ˆï¼š${val}<br>å®Œæ•´ç¼–ç ï¼š${correctString}`;
            } else {
                feedback.className = 'quiz-feedback quiz-wrong';
                feedback.innerHTML = `<strong>âŒ å›ç­”é”™è¯¯</strong><br>ä½ çš„ç­”æ¡ˆï¼š${val}<br>æ­£ç¡®ç­”æ¡ˆï¼š<strong>${correctString}</strong>`;
            }
            
            // é”å®šå¹¶æ˜¾ç¤ºä¸‹ä¸€æ­¥
            inputEl.disabled = true;
            document.getElementById('quiz-submit-btn').style.display = 'none';
            const nextBtn = document.getElementById('quiz-next-btn');
            nextBtn.style.display = 'block';
            nextBtn.focus();
        }

        // ======================================================
        // ä¸šåŠ¡é€»è¾‘ï¼šå•æ¬¡éšæœº (Drill)
        // ======================================================
        function handleDrillStart() {
            const min = parseInt(document.getElementById('drill-min').value);
            const max = parseInt(document.getElementById('drill-max').value);
            
            if (isNaN(min) || isNaN(max) || min > max) { alert("èŒƒå›´æ— æ•ˆ"); return; }
            
            lastDrillMin = min;
            lastDrillMax = max;
            
            runDrillLogic(min, max);
        }

        function runDrillLogic(min, max) {
            const target = generateRandomNumber(min, max);
            const answer = getEncoding(target);

            setTimeout(() => {
                const conf = confirm(`ğŸ§  éšæœºæ•°å­—: ${target}\n(èŒƒå›´ ${min}-${max})\n\nè¯·è”æƒ³...\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹ç­”æ¡ˆã€‚`);
                if(conf) {
                    showResult(`âœ… ${target} çš„ç¼–ç `, `æ•°å­—: ${target}\nç¼–ç : ${answer}`, () => {
                        // ç»­æ¯é€»è¾‘ï¼šé‡æ–°è¯»å–ç»“æœé¡µé¢çš„è®¾ç½®æ¡†
                        const newMin = parseInt(document.getElementById('next-min-input').value);
                        const newMax = parseInt(document.getElementById('next-max-input').value);
                        if (!isNaN(newMin)) { 
                            lastDrillMin = newMin; 
                            lastDrillMax = newMax;
                            runDrillLogic(newMin, newMax);
                        }
                    });
                    
                    // æ˜¾ç¤ºå•æ¬¡è®­ç»ƒä¸“ç”¨çš„è®¾ç½®æ 
                    document.getElementById('result-setting-bar').style.display = 'block';
                    document.getElementById('setting-single-content').style.display = 'flex';
                    document.getElementById('setting-multi-content').style.display = 'none';
                    document.getElementById('next-min-input').value = min;
                    document.getElementById('next-max-input').value = max;
                } else {
                    showMenuUI();
                }
            }, 50);
        }

        // ======================================================
        // ä¸šåŠ¡é€»è¾‘ï¼šå…¶ä»– (Input/Result/Data)
        // ======================================================
        function validateInput() {
            const val = document.getElementById('input-field').value;
            document.getElementById('input-submit-btn').disabled = (val.trim() === "");
        }

        function handleInputSubmit() {
            const val = document.getElementById('input-field').value.trim();
            if (!val) return;

            if (currentPageType === 'multi') {
                const n = parseInt(val);
                if (n > 0 && n <= 20) {
                    currentMultiCount = n;
                    runMultiLogic(n);
                } else {
                    alert("è¯·è¾“å…¥ 1-20");
                }
            } else if (currentPageType === 'query') {
                runQueryLogic(val);
            }
        }

        function runMultiLogic(N) {
            const numbers = [];
            for(let i=0; i<N; i++) numbers.push(generateRandomNumber(lastDrillMin, lastDrillMax));
            
            const listStr = numbers.join(', ');
            const answerStr = numbers.map(n => `${n}: ${getEncoding(n)}`).join('\n');
            
            setTimeout(() => {
                const conf = confirm(`è®°å¿† ${N} ä¸ªæ•°å­—:\n${listStr}\n\nå‡†å¤‡å¥½æŸ¥çœ‹ç­”æ¡ˆå—ï¼Ÿ`);
                if(conf) {
                    showResult("âœ… å¤šé‡è®°å¿†ç­”æ¡ˆ", `**æ•°å­—:**\n${answerStr}`, () => {
                        const nextN = parseInt(document.getElementById('next-count-input').value);
                        runMultiLogic(nextN);
                    });
                    // æ˜¾ç¤ºå¤šé‡ä¸“ç”¨çš„è®¾ç½®æ 
                    document.getElementById('result-setting-bar').style.display = 'block';
                    document.getElementById('setting-single-content').style.display = 'none';
                    document.getElementById('setting-multi-content').style.display = 'flex';
                    document.getElementById('next-count-input').value = N;
                } else {
                    showMenuUI();
                }
            }, 50);
        }

        function runQueryLogic(numStr) {
            const n = parseInt(numStr);
            // ç®€å•çš„èŒƒå›´æ£€æŸ¥
            currentQueryNumber = n;
            const ans = getEncoding(numStr);
            
            showResult(`ğŸ” æŸ¥è¯¢: ${numStr}`, `ç¼–ç : ${ans}`, () => showInputPage('query'));
            document.getElementById('result-view-next-btn').style.display = 'block';
        }

        function showResult(title, text, nextCallback) {
            hideAllViews();
            views.result.classList.add('active');
            document.getElementById('result-page-title').textContent = title;
            document.getElementById('result-page-content').textContent = text;
            document.getElementById('result-view-next-btn').style.display = 'none'; // reset
            
            nextActionCallback = nextCallback;
            const btn = document.getElementById('result-next-btn');
            if (nextCallback) {
                btn.style.display = 'block';
                btn.textContent = "ç»§ç»­ä¸‹ä¸€ç»„";
            } else {
                btn.style.display = 'none';
            }
        }

        function handleResultNext() {
            if(nextActionCallback) nextActionCallback();
            else showMenuUI();
        }

        function handleViewNext() {
             if (currentQueryNumber === null) return;
             runQueryLogic(String(currentQueryNumber + 1));
        }

        // ======================================================
        // æ•°æ®åŠ è½½
        // ======================================================
        async function initData() {
            // 1. å°è¯•æœ¬åœ°ç¼“å­˜
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                try {
                    number_encodings = JSON.parse(cached);
                    console.log("Loaded from cache");
                } catch(e) { localStorage.removeItem(CACHE_KEY); }
            }
            showMenuUI();

            // 2. è¿œç¨‹æ›´æ–°
            try {
                document.getElementById('data-status').textContent = "æ•°æ®: æ›´æ–°ä¸­...";
                const res = await fetch(JSON_URL);
                const json = await res.json();
                number_encodings = json;
                localStorage.setItem(CACHE_KEY, JSON.stringify(json));
                document.getElementById('data-status').textContent = "æ•°æ®: å·²åŠ è½½ (æœ€æ–°)";
            } catch(e) {
                console.error(e);
                if(!Object.keys(number_encodings).length) {
                    document.getElementById('data-status').textContent = "æ•°æ®: åŠ è½½å¤±è´¥";
                } else {
                    document.getElementById('data-status').textContent = "æ•°æ®: å·²åŠ è½½ (ç¼“å­˜)";
                }
            }
        }

        initData();
    </script>
</body>
</html>
