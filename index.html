<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f8f8;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007aff;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .data-status {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 30px;
        }
        .menu-list {
            list-style: none;
            padding: 0;
        }
        .menu-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .menu-item:hover {
            background-color: #e5e5e5;
        }
        .menu-item-title {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        .menu-item-detail {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }
        .current-view {
            display: none;
            padding-top: 20px;
        }
        .current-view.active {
            display: block;
        }
        input[type="number"], button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .input-group input {
            margin-bottom: 0;
        }
        button {
            background-color: #007aff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #005bb5;
        }
        .result-box {
            background-color: #f0f8ff;
            border: 1px solid #cfe2ff;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .result-title {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .btn-red {
            background-color: #ff3b30;
        }
        .btn-red:hover:not(:disabled) {
            background-color: #cc2d26;
        }
        .btn-green {
            background-color: #34c759;
        }
        .btn-green:hover:not(:disabled) {
            background-color: #248a3d;
        }
        
        /* --- è®¾ç½®æ æ ·å¼ --- */
        .setting-bar {
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }
        .setting-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .setting-bar input {
            text-align: center;
            padding: 5px;
            margin-bottom: 0;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        /* é’ˆå¯¹ä¸åŒè¾“å…¥æ¡†çš„å®½åº¦è°ƒæ•´ */
        .input-short { width: 50px; }
        .input-medium { width: 70px; }
        .setting-bar label {
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</h1>
        <div class="data-status" id="data-status">æ•°æ®: ç¼ºå¤±</div>

        <div id="menu-page" class="current-view active">
            <ul class="menu-list">
                <li class="menu-item" onclick="handleMenuSelect(0)">
                    <div class="menu-item-title">ğŸ§  1. å•æ¬¡éšæœºè®­ç»ƒ</div>
                    <div class="menu-item-detail">è®¾å®šæ•°å­—èŒƒå›´ï¼Œé€ä¸ªéšæœºè®­ç»ƒ</div>
                </li>
                <li class="menu-item" onclick="handleMenuSelect(1)">
                    <div class="menu-item-title">ğŸ”¢ 2. å¤šé‡æ•°å­—è®°å¿†</div>
                    <div class="menu-item-detail">è¾“å…¥æ•°é‡ Nï¼Œéšæœº N ä¸ªæ•°å­—ç»„è¿›è¡Œè®°å¿†</div>
                </li>
                <li class="menu-item" onclick="handleMenuSelect(2)">
                    <div class="menu-item-title">ğŸ” 3. æŸ¥è¯¢æ¡©å­</div>
                    <div class="menu-item-detail">è¾“å…¥æ•°å­—ï¼Œç«‹å³æ˜¾ç¤ºå¯¹åº”ç¼–ç </div>
                </li>
            </ul>
        </div>

        <div id="range-page" class="current-view">
            <div class="result-title">è®¾å®šè®­ç»ƒèŒƒå›´</div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">è¯·è¾“å…¥èŒƒå›´ (ä¾‹å¦‚ 133 - 255)</div>
            
            <div class="input-group">
                <input type="number" id="range-min" placeholder="æœ€å°å€¼" value="100">
                <span style="align-self: center;">-</span>
                <input type="number" id="range-max" placeholder="æœ€å¤§å€¼" value="999">
            </div>

            <button onclick="handleRangeSubmit()">å¼€å§‹è®­ç»ƒ</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="input-page" class="current-view">
            <div class="result-title" id="input-page-title"></div>
            <input type="number" id="input-field" placeholder="" oninput="validateInput()">
            <button id="input-submit-btn" onclick="handleInputSubmit()">ç¡®å®š</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>

        <div id="result-page" class="current-view">
            <div class="result-title" id="result-page-title"></div>
            <div class="result-box" id="result-page-content"></div>
            
            <div id="result-setting-bar" class="setting-bar">
                
                <div id="setting-multi-content" class="setting-content" style="display:none;">
                    <label>ä¸‹è½®æ•°é‡:</label>
                    <input type="number" id="next-count-input" class="input-short" min="1" max="20" value="5">
                    <span>ä¸ª</span>
                </div>

                <div id="setting-single-content" class="setting-content" style="display:none;">
                    <label>èŒƒå›´:</label>
                    <input type="number" id="next-min-input" class="input-medium" placeholder="Min">
                    <span>-</span>
                    <input type="number" id="next-max-input" class="input-medium" placeholder="Max">
                </div>

            </div>

            <button id="result-view-next-btn" class="btn-green" style="display: none;" onclick="handleViewNext()">æŸ¥çœ‹ä¸‹ä¸€ä¸ª ></button>
            
            <button id="result-next-btn" class="btn-red" onclick="handleResultNext()">ç»§ç»­æ­¤é¡¹æ“ä½œ</button>
            <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
        </div>
    </div>

    <script>
        // ======================================================
        // Web å®ç° JavaScript é€»è¾‘
        // ======================================================

        const JSON_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/1000code.json";
        const CACHE_KEY = "1000code_cache";

        let number_encodings = {};
        const DEFAULT_MIN = 100;
        const DEFAULT_MAX = 999;
        
        let currentPageType = ""; 
        let nextActionCallback = null; 
        
        // --- æ ¸å¿ƒçŠ¶æ€å˜é‡ ---
        let currentQueryNumber = null;
        let currentDrillMin = DEFAULT_MIN; 
        let currentDrillMax = DEFAULT_MAX; 
        let currentMultiCount = 5; 

        // --- DOM å…ƒç´ å¼•ç”¨ ---
        const menuPage = document.getElementById('menu-page');
        const inputPage = document.getElementById('input-page');
        const rangePage = document.getElementById('range-page'); 
        const resultPage = document.getElementById('result-page');
        const dataStatus = document.getElementById('data-status');
        const mainTitle = document.getElementById('main-title');

        const inputPageTitle = document.getElementById('input-page-title');
        const inputField = document.getElementById('input-field');
        const inputSubmitBtn = document.getElementById('input-submit-btn');

        const rangeMinInput = document.getElementById('range-min'); 
        const rangeMaxInput = document.getElementById('range-max'); 

        const resultPageTitle = document.getElementById('result-page-title');
        const resultPageContent = document.getElementById('result-page-content');
        const resultNextBtn = document.getElementById('result-next-btn');
        const resultViewNextBtn = document.getElementById('result-view-next-btn');
        
        // è®¾ç½®æ å¼•ç”¨
        const resultSettingBar = document.getElementById('result-setting-bar');
        const settingMultiContent = document.getElementById('setting-multi-content');
        const settingSingleContent = document.getElementById('setting-single-content');
        const nextCountInput = document.getElementById('next-count-input');
        const nextMinInput = document.getElementById('next-min-input');
        const nextMaxInput = document.getElementById('next-max-input');

        // --- æ ¸å¿ƒè¾…åŠ©å‡½æ•° ---

        function toast(message) {
            console.log("Toast:", message);
        }

        function generateRandomNumber(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            const randomNumber = Math.floor(Math.random() * (max - min + 1)) + min;
            return String(randomNumber);
        }

        function getEncoding(numStr) {
            return number_encodings[numStr] || `[${numStr} ç¼–ç ç¼ºå¤±!]`;
        }

        // --- ç•Œé¢åˆ‡æ¢é€»è¾‘ ---

        function hideAllViews() {
            menuPage.classList.remove('active');
            inputPage.classList.remove('active');
            resultPage.classList.remove('active');
            rangePage.classList.remove('active');
            
            // é»˜è®¤éšè—ç»“æœé¡µçš„æ‰€æœ‰å·¥å…·æ 
            resultSettingBar.style.display = 'none';
            settingMultiContent.style.display = 'none';
            settingSingleContent.style.display = 'none';
        }

        function showMenuUI() {
            hideAllViews();
            menuPage.classList.add('active');
            const statusText = Object.keys(number_encodings).length ? "å·²åŠ è½½" : "ç¼ºå¤±";
            mainTitle.textContent = `æ•°å­—æ¡©è®°å¿†è®­ç»ƒ`;
            dataStatus.textContent = `æ•°æ®: ${statusText}`;
        }

        function showRangePageUI() {
            hideAllViews();
            rangePage.classList.add('active');
            rangeMinInput.value = currentDrillMin;
            rangeMaxInput.value = currentDrillMax;
        }

        function showInputPage(type) {
            currentPageType = type;
            hideAllViews();
            inputPage.classList.add('active');

            const isMulti = type === "multi";
            const rangeInfo = `(å½“å‰èŒƒå›´: ${currentDrillMin}-${currentDrillMax})`;
            const pageTitle = isMulti ? "è¾“å…¥å¤šé‡è®°å¿†æ•°é‡ N" : "è¾“å…¥æŸ¥è¯¢æ•°å­—";
            const placeholder = isMulti ? "è¯·è¾“å…¥æ•°é‡ N (1-20)" : `è¯·è¾“å…¥ ${DEFAULT_MIN} åˆ° ${DEFAULT_MAX} çš„æ•°å­—`;

            inputPageTitle.innerHTML = `${pageTitle} <div style='font-size:12px;color:#888;font-weight:normal;margin-top:5px;'>${rangeInfo}</div>`;
            
            inputField.placeholder = placeholder;
            inputField.value = "";
            inputField.setAttribute('min', isMulti ? 1 : DEFAULT_MIN);
            inputField.setAttribute('max', isMulti ? 20 : DEFAULT_MAX);
            inputField.focus();
            validateInput();
        }
        
        function validateInput() {
            const input = inputField.value.trim();
            inputSubmitBtn.disabled = input === "";
        }

        function showResultUI(title, message, nextAction) {
            nextActionCallback = nextAction;
            hideAllViews();
            resultPage.classList.add('active');

            resultPageTitle.textContent = title;
            resultPageContent.textContent = message;

            resultViewNextBtn.style.display = 'none';

            if (nextAction) {
                resultNextBtn.textContent = "ç»§ç»­ä¸‹ä¸€ç»„"; 
                resultNextBtn.style.display = 'block';
                resultNextBtn.classList.add('btn-red');
            } else {
                resultNextBtn.style.display = 'none';
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å®ç° ---

        function handleRangeSubmit() {
            const minVal = parseInt(rangeMinInput.value);
            const maxVal = parseInt(rangeMaxInput.value);

            if (isNaN(minVal) || isNaN(maxVal)) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
                return;
            }
            if (minVal > maxVal) {
                alert("æœ€å°å€¼ä¸èƒ½å¤§äºæœ€å¤§å€¼ï¼");
                return;
            }
            currentDrillMin = minVal;
            currentDrillMax = maxVal;
            drillRandomNumber(currentDrillMin, currentDrillMax);
        }

        function drillRandomNumber(min, max) {
            if (!Object.keys(number_encodings).length) {
                alert("âš ï¸ é”™è¯¯: æ•°æ®æœªåŠ è½½ã€‚");
                return;
            }
            const targetNumber = generateRandomNumber(min, max);
            const correctAnswer = getEncoding(targetNumber);

            setTimeout(() => {
                const userConfirmed = confirm(`ğŸ§  éšæœºæ•°å­—: ${targetNumber}\n\nèŒƒå›´: ${min} - ${max}\n\nè¯·é»˜æƒ³å¯¹åº”çš„å›¾åƒç¼–ç ã€‚\nå‡†å¤‡å¥½æŸ¥çœ‹ç­”æ¡ˆäº†å—ï¼Ÿ`);

                if (userConfirmed) {
                    showResultUI(`âœ… ${targetNumber} çš„ç¼–ç `,
                        `æ•°å­—: ${targetNumber}\n\nç¼–ç : ${correctAnswer}`,
                        
                        // --- å…³é”®å›è°ƒï¼šå•æ¬¡è®­ç»ƒçš„ç»§ç»­é€»è¾‘ ---
                        () => {
                            // è¯»å–ç»“æœé¡µä¸Šçš„è¾“å…¥æ¡†
                            const newMin = parseInt(nextMinInput.value);
                            const newMax = parseInt(nextMaxInput.value);
                            
                            if (isNaN(newMin) || isNaN(newMax) || newMin > newMax) {
                                alert("èŒƒå›´æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥");
                                return;
                            }
                            // æ›´æ–°å…¨å±€çŠ¶æ€ï¼Œå¹¶å¼€å§‹ä¸‹ä¸€è½®
                            currentDrillMin = newMin;
                            currentDrillMax = newMax;
                            drillRandomNumber(newMin, newMax);
                        }
                    );

                    // --- æ˜¾ç¤ºèŒƒå›´è®¾ç½®æ  ---
                    resultSettingBar.style.display = 'block';
                    settingSingleContent.style.display = 'flex'; // æ˜¾ç¤ºå•æ¬¡è®¾ç½®å†…å®¹
                    settingMultiContent.style.display = 'none';  // éšè—å¤šé‡è®¾ç½®å†…å®¹
                    
                    // å¡«å…¥å½“å‰å€¼
                    nextMinInput.value = min;
                    nextMaxInput.value = max;

                } else {
                    showMenuUI();
                }
            }, 100);
        }

        function drillMultipleNumbers(N) {
            const N_val = parseInt(N);
            const numbers = new Set();
            
            let attempts = 0;
            while (numbers.size < N_val && attempts < 1000) {
                numbers.add(generateRandomNumber(currentDrillMin, currentDrillMax));
                attempts++;
            }
            
            const numberList = Array.from(numbers);
            const formattedList = numberList.map(numStr => `${numStr}: ${getEncoding(numStr)}`).join('\n');
            const plainNumberList = numberList.join(', ');
            const rangeText = `(èŒƒå›´: ${currentDrillMin}-${currentDrillMax})`;

            setTimeout(() => {
                const userConfirmed = confirm(`ğŸ§  ${numbers.size} ä¸ªæ•°å­—éšæœºè®­ç»ƒ ${rangeText}\n\nè¯·å°è¯•è”æƒ³å¹¶è®°å¿†è¿™ç»„æ•°å­—ï¼š\n**${plainNumberList}**\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿ\n\nç‚¹å‡»â€œç¡®å®šâ€æŸ¥çœ‹ç­”æ¡ˆï¼Œç‚¹å‡»â€œå–æ¶ˆâ€è¿”å›èœå•ã€‚`);

                if (userConfirmed) {
                    showResultUI("âœ… ç¼–ç ç­”æ¡ˆ",
                        `**æ•°å­—åˆ—è¡¨:**\n${formattedList}`,
                        
                        // --- å…³é”®å›è°ƒï¼šå¤šé‡è®­ç»ƒçš„ç»§ç»­é€»è¾‘ ---
                        () => {
                            const nextN = parseInt(nextCountInput.value);
                            if (nextN > 0 && nextN <= 20) {
                                drillMultipleNumbers(nextN);
                            } else {
                                alert("è¯·è¾“å…¥ 1-20 ä¹‹é—´çš„æœ‰æ•ˆæ•°é‡");
                            }
                        }
                    );
                    
                    // --- æ˜¾ç¤ºæ•°é‡è®¾ç½®æ  ---
                    resultSettingBar.style.display = 'block';
                    settingMultiContent.style.display = 'flex'; // æ˜¾ç¤ºå¤šé‡è®¾ç½®å†…å®¹
                    settingSingleContent.style.display = 'none'; // éšè—å•æ¬¡è®¾ç½®å†…å®¹
                    
                    nextCountInput.value = N_val; 

                } else {
                    showMenuUI();
                }
            }, 100);
        }

        function handleViewNext() {
            if (currentQueryNumber === null) return;
            let nextNum = currentQueryNumber + 1;
            if (nextNum > DEFAULT_MAX) {
                alert("å·²ç»åˆ°è¾¾æœ€å¤§æ•°å­—ï¼");
                return;
            }
            currentQueryNumber = nextNum;
            const numStr = String(nextNum);
            const encoding = getEncoding(numStr);
            showResultUI(`ğŸ” ${numStr} å¯¹åº”çš„ç¼–ç `,
                `æ•°å­—: ${numStr}\n\nç¼–ç : ${encoding}`,
                () => showInputPage("query")
            );
            resultViewNextBtn.style.display = 'block';
        }

        // --- äº‹ä»¶å¤„ç†å‡½æ•° ---

        function handleMenuSelect(index) {
            if (!Object.keys(number_encodings).length) {
                alert("âš ï¸ é”™è¯¯: æ•°æ®æœªåŠ è½½ã€‚");
                return;
            }
            switch (index) {
                case 0: showRangePageUI(); break; 
                case 1: showInputPage("multi"); break;
                case 2: showInputPage("query"); break;
            }
        }

        function handleInputSubmit() {
            const input = inputField.value.trim();
            if (input === "") { toast("è¾“å…¥ä¸èƒ½ä¸ºç©º"); return; }

            if (currentPageType === "multi") {
                const N = parseInt(input);
                if (N > 0 && N <= 20) {
                    currentMultiCount = N;
                    drillMultipleNumbers(currentMultiCount);
                } else {
                    alert("é”™è¯¯: è¯·è¾“å…¥ 1 åˆ° 20 ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ã€‚");
                    showInputPage("multi");
                }
            } else if (currentPageType === "query") {
                const numStr = input;
                const num = parseInt(numStr);
                if (num >= DEFAULT_MIN && num <= DEFAULT_MAX) {
                    currentQueryNumber = num;
                    const encoding = getEncoding(numStr);
                    showResultUI(`ğŸ” ${numStr} å¯¹åº”çš„ç¼–ç `,
                        `æ•°å­—: ${numStr}\n\nç¼–ç : ${encoding}`,
                        () => showInputPage("query")
                    );
                    resultViewNextBtn.style.display = 'block';
                } else {
                    alert(`âš ï¸ æ•°å­—é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„ ${DEFAULT_MIN} åˆ° ${DEFAULT_MAX} çš„æ•°å­—ã€‚`);
                    showInputPage("query");
                }
            }
        }

        function handleResultNext() {
            if (nextActionCallback) {
                nextActionCallback();
            } else {
                showMenuUI();
            }
        }

        // --- åŠ è½½é€»è¾‘ ---
        function loadFromCache() {
            const jsonStr = localStorage.getItem(CACHE_KEY);
            if (jsonStr) {
                try {
                    number_encodings = JSON.parse(jsonStr);
                    toast("ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®ã€‚");
                    return true;
                } catch (e) {
                    localStorage.removeItem(CACHE_KEY);
                    return false;
                }
            }
            return false;
        }

        async function updateFromRemote(isInitialLoad) {
            if (isInitialLoad) dataStatus.textContent = "æ•°æ®: æ­£åœ¨åŠ è½½...";
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const newEncodings = await response.json();
                if (JSON.stringify(newEncodings) !== JSON.stringify(number_encodings)) {
                    number_encodings = newEncodings;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(newEncodings));
                    dataStatus.textContent = "æ•°æ®: å·²åŠ è½½";
                }
                return true;
            } catch (error) {
                console.error("åŠ è½½å¤±è´¥:", error);
                if (isInitialLoad && !Object.keys(number_encodings).length) {
                    dataStatus.textContent = "æ•°æ®: ç¼ºå¤±";
                    alert("æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                }
                return false;
            }
        }

        async function init() {
            const cacheLoaded = loadFromCache();
            if (cacheLoaded) {
                showMenuUI();
                await updateFromRemote(false);
            } else {
                await updateFromRemote(true);
                showMenuUI();
            }
        }

        init();
    </script>
</body>
</html>
