<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f8f8f8; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007aff; font-size: 24px; margin-bottom: 20px; text-align: center; }
        .data-status { text-align: center; font-size: 14px; color: #888; margin-bottom: 30px; }

        /* èœå•æ ·å¼ */
        .menu-list { list-style: none; padding: 0; }
        .menu-item { background-color: #f9f9f9; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; padding: 15px; cursor: pointer; transition: background-color 0.2s; }
        .menu-item:hover { background-color: #e5e5e5; }
        .menu-item.disabled { background-color: #f5f5f5; color: #aaa; cursor: not-allowed; opacity: 0.6; } /* ç¦ç”¨æ ·å¼ */
        .menu-item-title { font-weight: bold; font-size: 18px; color: #333; }
        .menu-item.disabled .menu-item-title { color: #aaa; }
        .menu-item-detail { font-size: 14px; color: #888; margin-top: 5px; }
        .menu-item.disabled .menu-item-detail { color: #ccc; }

        /* è§†å›¾åˆ‡æ¢ */
        .current-view { display: none; padding-top: 20px; }
        .current-view.active { display: block; }

        /* è¾“å…¥æ§ä»¶ */
        input[type="number"], input[type="text"], button { padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 15px; width: 100%; box-sizing: border-box; font-size: 16px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-group input { margin-bottom: 0; }

        /* æŒ‰é’® */
        button { background-color: #007aff; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #005bb5; }
        .btn-red { background-color: #ff3b30; }
        .btn-red:hover:not(:disabled) { background-color: #cc2d26; }
        .btn-green { background-color: #34c759; }
        .btn-green:hover:not(:disabled) { background-color: #248a3d; }

        /* ç»“æœå±•ç¤º */
        .result-box { background-color: #f0f8ff; border: 1px solid #cfe2ff; padding: 15px; border-radius: 8px; white-space: pre-wrap; font-size: 16px; margin-bottom: 20px; }
        .result-title { font-weight: bold; font-size: 20px; margin-bottom: 10px; }

        /* è®¾ç½®æ  */
        .setting-bar { display: none; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .setting-content { display: flex; align-items: center; justify-content: center; gap: 8px; }
        /* è°ƒæ•´å¤šé‡è®°å¿†çš„è®¾ç½®æ å¸ƒå±€ */
        #setting-multi-content { flex-direction: column; align-items: stretch; }
        .setting-bar input { text-align: center; padding: 5px; margin-bottom: 0; border: 1px solid #ddd; font-size: 14px; }
        .input-short { width: 50px; }
        .input-medium { width: 70px; }
        .setting-bar label { font-weight: bold; font-size: 14px; }

        /* --- é»˜å†™æµ‹è¯•ä¸“å±æ ·å¼ --- */
        .quiz-card { text-align: center; padding: 20px; background: #fff; border: 1px solid #eee; border-radius: 10px; margin-bottom: 20px; }
        .quiz-number { font-size: 60px; font-weight: bold; color: #007aff; display: block; margin: 10px 0; letter-spacing: 2px; }
        .quiz-feedback { padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; display: none; }
        .quiz-correct { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .quiz-wrong { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .quiz-info { font-size: 12px; color: #999; margin-bottom: 20px; }

        /* æ–°å¢çš„æ¸…é™¤ç¼“å­˜æŒ‰é’®æ ·å¼ */
        .clear-cache-btn {
            margin-top: 25px;
            background-color: #6c757d; /* ç°è‰² */
            color: white;
            font-size: 14px;
            padding: 8px;
        }
        .clear-cache-btn:hover:not(:disabled) {
            background-color: #5a6268;
        }

        /* æ•…äº‹åˆ—è¡¨æ ·å¼ */
        .story-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .story-list-item { background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 6px; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .story-list-item:hover { background-color: #bae7ff; }

        /* æ•…äº‹è¯¦æƒ…æ ·å¼ */
        .story-detail-box { background-color: #f0fff0; border: 1px solid #b7eb8f; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .story-detail-box strong { font-size: 24px; color: #389e0d; display: block; margin-bottom: 10px; }
        .story-detail-box p { white-space: pre-wrap; line-height: 1.6; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="main-title">æ•°å­—æ¡©è®°å¿†è®­ç»ƒ</h1>
    <div class="data-status" id="data-status">ç¼–ç : ç¼ºå¤±</div>
    <div class="data-status" id="story-status" style="margin-top: -20px;">æ•…äº‹: ç¼ºå¤±</div>
    <div class="data-status" id="pegs100-status" style="margin-top: -20px;">100æ¡©: ç¼ºå¤±</div>

    <div id="menu-page" class="current-view active">
        <ul class="menu-list">
            <li class="menu-item" onclick="showDrillRangeUI()">
                <div class="menu-item-title">ğŸ§  1. å•æ¬¡éšæœºè®­ç»ƒ (æŸ¥ç¼–ç )</div>
                <div class="menu-item-detail">çœ‹æ•°å­— -> è„‘æµ·è”æƒ³ -> çœ‹ç­”æ¡ˆæ ¸å¯¹</div>
            </li>
            <li class="menu-item" onclick="showQuizRangeUI()">
                <div class="menu-item-title">ğŸ“ 2. é»˜å†™æµ‹è¯• (è¾“ç¼–ç )</div>
                <div class="menu-item-detail">çœ‹æ•°å­— -> è¾“å…¥æ–‡å­— -> ç³»ç»Ÿè‡ªåŠ¨åˆ¤åˆ†</div>
            </li>
            <li class="menu-item" onclick="showInputPage('multi')">
                <div class="menu-item-title">ğŸ”¢ 3. å¤šé‡æ•°å­—è®°å¿†</div>
                <div class="menu-item-detail">ä¸€æ¬¡æ€§è®°å¿† N ä¸ªæ•°å­—</div>
            </li>
            <li class="menu-item" onclick="showInputPage('query')">
                <div class="menu-item-title">ğŸ” 4. æŸ¥è¯¢æ¡©å­ç¼–ç </div>
                <div class="menu-item-detail">æŸ¥æ•°å­—å¯¹åº”çš„ç¼–ç  (000-999)</div>
            </li>
            <li class="menu-item" onclick="showStoryMenuUI()">
                <div class="menu-item-title">ğŸ“– 5. æ•°å­—æ¡©æ•…äº‹æµè§ˆ (æ–°å¢)</div>
                <div class="menu-item-detail">æŸ¥çœ‹ 100-999 æ‰€æœ‰æ•…äº‹</div>
            </li>
            <li class="menu-item pegs100-required" onclick="showPegs100MenuUI()">
                <div class="menu-item-title">ğŸ§® 6. 100 æ•°å­—æ¡©è®­ç»ƒ (00-99)</div>
                <div class="menu-item-detail">è®­ç»ƒ 00 åˆ° 99 çš„æ•°å­—æ¡©</div>
            </li>
        </ul>
        <button class="clear-cache-btn" onclick="clearCacheAndReload()">
            ğŸ”„ æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½æ•°æ®
        </button>
    </div>

    <div id="story-menu-page" class="current-view">
        <div class="result-title">æ•°å­—æ¡©æ•…äº‹æµè§ˆ</div>
        <ul class="menu-list">
            <li class="menu-item" onclick="showStoryListUI()">
                <div class="menu-item-title">ğŸ“œ æ•…äº‹åˆ—è¡¨ (100-999)</div>
                <div class="menu-item-detail">æŒ‰æ•°å­—æ®µæŸ¥çœ‹æ‰€æœ‰æ•…äº‹</div>
            </li>
            <li class="menu-item" onclick="showRandomStory()">
                <div class="menu-item-title">ğŸ² éšæœºä¸€ä¸ªæ•…äº‹</div>
                <div class="menu-item-detail">å¿«é€ŸæŸ¥çœ‹ä¸€ä¸ªæ•°å­—æ¡©çš„æ•…äº‹</div>
            </li>
            <li class="menu-item" onclick="showInputPage('storyQuery')">
                <div class="menu-item-title">ğŸ” æŸ¥è¯¢æ•…äº‹</div>
                <div class="menu-item-detail">è¾“å…¥æ•°å­—æŸ¥è¯¢å¯¹åº”æ•…äº‹</div>
            </li>
        </ul>
        <button onclick="showMenuUI()">è¿”å›æ•…äº‹èœå•</button>
    </div>

    <div id="story-list-page" class="current-view">
        <div class="result-title">100-999 æ•°å­—æ¡©æ•…äº‹åˆ—è¡¨</div>
        <ul id="story-list-content" class="story-list">
        </ul>
        <button onclick="showStoryMenuUI()">è¿”å›æ•…äº‹èœå•</button>
    </div>

    <div id="pegs100-menu-page" class="current-view">
        <div class="result-title">100 æ•°å­—æ¡©è®­ç»ƒ (00-99)</div>
        <ul class="menu-list">
            <li class="menu-item" onclick="showPegs100ListUI()">
                <div class="menu-item-title">ğŸ“‹ æ¡©å­åˆ—è¡¨ (00-99)</div>
                <div class="menu-item-detail">æŸ¥çœ‹æ‰€æœ‰ 100 ä¸ªæ•°å­—æ¡©</div>
            </li>
            <li class="menu-item" onclick="showRandomPeg100()">
                <div class="menu-item-title">ğŸ² éšæœºä¸€ä¸ªæ¡©å­</div>
                <div class="menu-item-detail">å¿«é€ŸæŸ¥çœ‹ä¸€ä¸ª 00-99 çš„æ•°å­—æ¡©</div>
            </li>
            <li class="menu-item" onclick="showInputPage('pegs100Query')">
                <div class="menu-item-title">ğŸ” æŸ¥è¯¢æ¡©å­</div>
                <div class="menu-item-detail">è¾“å…¥ 00-99 æ•°å­—æŸ¥è¯¢å¯¹åº”æ¡©å­</div>
            </li>
        </ul>
        <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
    </div>

    <div id="pegs100-list-page" class="current-view">
        <div class="result-title">00-99 æ•°å­—æ¡©åˆ—è¡¨</div>
        <div class="result-box" id="pegs100-list-content" style="text-align: left; font-size: 14px;">
        </div>
        <button onclick="showPegs100MenuUI()">è¿”å› 100 æ¡©èœå•</button>
    </div>

    <div id="drill-range-page" class="current-view">
        <div class="result-title">éšæœºè®­ç»ƒ - è®¾å®šèŒƒå›´</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">è¾“å…¥æ•°å­—èŒƒå›´ (å¦‚ 100-999)</div>
        <div class="input-group">
            <input type="number" id="drill-min" placeholder="æœ€å°å€¼" value="100">
            <span style="align-self: center;">-</span>
            <input type="number" id="drill-max" placeholder="æœ€å¤§å€¼" value="999">
        </div>
        <button onclick="handleDrillStart()">å¼€å§‹è®­ç»ƒ</button>
        <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
    </div>

    <div id="quiz-range-page" class="current-view">
        <div class="result-title">é»˜å†™æµ‹è¯• - è®¾å®šèŒƒå›´</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">è¾“å…¥æ•°å­—èŒƒå›´ï¼Œç³»ç»Ÿå°†éšæœºå‡ºé¢˜</div>
        <div class="input-group">
            <input type="number" id="quiz-min-setup" placeholder="æœ€å°å€¼" value="100">
            <span style="align-self: center;">-</span>
            <input type="number" id="quiz-max-setup" placeholder="æœ€å¤§å€¼" value="999">
        </div>
        <button onclick="handleQuizStart()">å¼€å§‹æµ‹è¯•</button>
        <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
    </div>

    <div id="quiz-working-page" class="current-view">
        <div class="quiz-card">
            <div class="quiz-info">è¯·é»˜å†™ä¸‹æ–¹æ•°å­—å¯¹åº”çš„æ¡©å­</div>
            <span class="quiz-number" id="quiz-question-num">000</span>
            <div class="quiz-info">(èŒƒå›´: <span id="quiz-range-label"></span>)</div>
        </div>

        <div id="quiz-result-box" class="quiz-feedback"></div>

        <input type="text" id="quiz-answer-input" placeholder="è¾“å…¥æ¡©å­ (å¦‚: è®®æ”¿å…)" onkeydown="if(event.key==='Enter') checkQuizAnswer()">

        <button id="quiz-submit-btn" onclick="checkQuizAnswer()">æäº¤</button>
        <button id="quiz-next-btn" class="btn-green" style="display:none;" onclick="nextQuizRound()">ä¸‹ä¸€ä¸ª</button>
        <button onclick="showMenuUI()" style="margin-top: 10px; background-color: #666;">é€€å‡ºæµ‹è¯•</button>
    </div>

    <div id="input-page" class="current-view">
        <div class="result-title" id="input-page-title"></div>
        <div id="multi-options" style="display:none; margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; text-align: left;">
            <div style="font-weight: bold; margin-bottom: 10px;">é€‰æ‹©æ•°å­—æ¡©èŒƒå›´: (å¯å¤šé€‰)</div>
            <div style="display:flex; justify-content: space-around; gap: 10px;">
                <label style="flex-grow: 1; padding: 8px; background: #eee; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="multi-range" id="multi-range-100" value="100" checked> 00-99 (100æ¡©)
                </label>
                <label style="flex-grow: 1; padding: 8px; background: #eee; border-radius: 4px; cursor: pointer;">
                    <input type="checkbox" name="multi-range" id="multi-range-1000" value="1000" checked> 100-999 (1000æ¡©)
                </label>
            </div>
        </div>
        <input type="number" id="input-field" placeholder="" oninput="validateInput()">
        <button id="input-submit-btn" onclick="handleInputSubmit()">ç¡®å®š</button>
        <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
    </div>

    <div id="result-page" class="current-view">
        <div class="result-title" id="result-page-title"></div>
        <div class="result-box" id="result-page-content"></div>

        <div id="result-setting-bar" class="setting-bar">
            <div id="setting-multi-content" class="setting-content" style="display:none; flex-direction: column;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; width: 100%; justify-content: center;">
                    <label style="flex-shrink: 0;">ä¸‹è½®æ•°é‡:</label>
                    <input type="number" id="next-count-input" class="input-short" min="1" max="20" value="5" style="width: 70px;">
                    <span style="flex-shrink: 0;">ä¸ª</span>
                </div>
                <div style="font-weight: bold; margin-bottom: 5px;">ä¸‹è½®èŒƒå›´: (å¯å¤šé€‰)</div>
                <div style="display:flex; justify-content: space-around; gap: 10px; width: 100%;">
                    <label style="flex-grow: 1; padding: 8px; background: #fff; border-radius: 4px; cursor: pointer; font-size: 14px; text-align: left;">
                        <input type="checkbox" name="next-multi-range" id="next-multi-range-100" value="100"> 00-99
                    </label>
                    <label style="flex-grow: 1; padding: 8px; background: #fff; border-radius: 4px; cursor: pointer; font-size: 14px; text-align: left;">
                        <input type="checkbox" name="next-multi-range" id="next-multi-range-1000" value="1000"> 100-999
                    </label>
                </div>
            </div>
            <div id="setting-single-content" class="setting-content" style="display:none;">
                <label>èŒƒå›´:</label>
                <input type="number" id="next-min-input" class="input-medium" placeholder="Min">
                <span>-</span>
                <input type="number" id="next-max-input" class="input-medium" placeholder="Max">
            </div>
        </div>

        <button id="result-view-next-btn" class="btn-green" style="display: none;" onclick="handleViewNext()">æŸ¥çœ‹ä¸‹ä¸€ä¸ª ></button>
        <button id="result-next-btn" class="btn-red" onclick="handleResultNext()">ç»§ç»­æ­¤é¡¹æ“ä½œ</button>
        <button onclick="showMenuUI()">è¿”å›ä¸»èœå•</button>
    </div>

</div>

<script>
    // ======================================================
    // æ•°æ®ä¸çŠ¶æ€
    // ======================================================
    const JSON_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/1000code.json";
    const STORY_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/1000story.json"; // æ–°å¢æ•…äº‹æ•°æ®æº
    const CODE100_URL = "https://raw.githubusercontent.com/losymear/cognition/refs/heads/main/files/json/100code.json"; // æ–°å¢ 100 æ¡©æ•°æ®æº
    const CACHE_KEY = "1000code_cache";
    const STORY_CACHE_KEY = "1000story_cache"; // æ–°å¢æ•…äº‹ç¼“å­˜é”®
    const CODE100_CACHE_KEY = "100code_cache"; // æ–°å¢ 100 æ¡©ç¼“å­˜é”®
    const DEFAULT_MIN = 100;
    const DEFAULT_MAX = 999;
    let number_encodings = {};
    let number_stories = {}; // å­˜å‚¨æ•…äº‹æ•°æ®
    let number_pegs100 = {}; // å­˜å‚¨ 100 æ¡©æ•°æ®

    // é¡µé¢å…ƒç´ å¼•ç”¨
    const views = {
        menu: document.getElementById('menu-page'),
        drillRange: document.getElementById('drill-range-page'),
        quizRange: document.getElementById('quiz-range-page'),
        quizWork: document.getElementById('quiz-working-page'),
        input: document.getElementById('input-page'),
        result: document.getElementById('result-page'),
        storyMenu: document.getElementById('story-menu-page'),
        storyList: document.getElementById('story-list-page'),
        pegs100Menu: document.getElementById('pegs100-menu-page'), // æ–°å¢
        pegs100List: document.getElementById('pegs100-list-page'), // æ–°å¢
    };

    // å…¨å±€çŠ¶æ€ (ç”¨äºè®°å½•ä¸Šä¸€æ¬¡çš„èŒƒå›´ï¼Œæ–¹ä¾¿è¿è´¯æ“ä½œ)
    let lastDrillMin = DEFAULT_MIN;
    let lastDrillMax = DEFAULT_MAX;
    let lastQuizMin = DEFAULT_MIN;
    let lastQuizMax = DEFAULT_MAX;

    let currentQuizTargetNum = null; // å½“å‰é»˜å†™æµ‹è¯•çš„æ•°å­—
    let currentPageType = "";
    let nextActionCallback = null;
    let currentQueryNumber = null;
    let currentMultiCount = 5;

    // ======================================================
    // æ ¸å¿ƒå·¥å…·å‡½æ•°
    // ======================================================
    function toast(message) {
        console.log(message);
        // å®é™…åº”ç”¨ä¸­å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå°çš„æç¤ºæ¡†
    }

    function hideAllViews() {
        Object.values(views).forEach(el => el.classList.remove('active'));
        // é‡ç½®ä¸€äº›é€šç”¨çš„å­å…ƒç´ æ˜¾ç¤ºçŠ¶æ€
        document.getElementById('result-setting-bar').style.display = 'none';
    }

    function generateRandomNumber(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        const num = Math.floor(Math.random() * (max - min + 1)) + min;
        // æ ¹æ®èŒƒå›´å†³å®šå¡«å……ä½æ•°
        if (max <= 99) {
            return String(num).padStart(2, '0'); // ä¸¤ä½æ•°å­—ï¼Œå¦‚ "00"
        }
        return String(num).padStart(3, '0'); // ä¸‰ä½æ•°å­—ï¼Œå¦‚ "000"
    }

    function getEncoding(numStr) {
        // ç¡®ä¿æŸ¥è¯¢çš„é”®æ˜¯ä¸‰ä½å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ 99 -> "099"
        const paddedNumStr = String(numStr).padStart(3, '0');
        return number_encodings[paddedNumStr] || `[ç¼ºå¤±]`;
    }

    function getPeg100(numStr) {
        // ç¡®ä¿æŸ¥è¯¢çš„é”®æ˜¯ä¸¤ä½å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ 9 -> "09"
        const paddedNumStr = String(numStr).padStart(2, '0');
        return number_pegs100[paddedNumStr] || `[ç¼ºå¤±]`;
    }

    function getStory(numStr) {
        // æ•…äº‹æ•°æ®æ˜¯æŒ‰æ®µè½é”®å€¼å¯¹å­˜å‚¨çš„ï¼Œå¦‚ "100-109"
        const num = parseInt(numStr);
        const start = Math.floor(num / 10) * 10;
        const key = `${start}-${start + 9}`;
        const storySegment = number_stories[key] || `[æ•…äº‹æ®µè½ ${key} ç¼ºå¤±]`;

        // æ•…äº‹å†…å®¹æ˜¯å½¢å¦‚ "A(100), B(101)" çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦æå–
        // æˆ‘ä»¬æŸ¥æ‰¾ (æ•°å­—) æ¨¡å¼
        const regex = new RegExp(`([^\\(]+)\\(${num}\\)`);
        const match = storySegment.match(regex);
        if (match) {
            // æ‰¾åˆ°ç²¾ç¡®åŒ¹é… (æ•°å­—) åçš„å‰ä¸€ä¸ªè¯æˆ–çŸ­è¯­
            return `**${match[1].trim()}**\n\nå®Œæ•´æ®µè½:\n${storySegment}`;
        }
        // å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…ï¼Œè¿”å›æ•´ä¸ªæ®µè½
        return `**æœªæ‰¾åˆ° ${num} å¯¹åº”çš„ç‹¬ç«‹æ¡©å­ï¼Œè¯·å‚è€ƒä»¥ä¸‹æ®µè½ï¼š**\n\n${storySegment}`;
    }

    function checkDataLoaded() {
        if (!Object.keys(number_encodings).length) {
            // alert("âš ï¸ ç¼–ç æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); // Don't block flow, just check
            return false;
        }
        return true;
    }

    function checkStoryLoaded() {
        if (!Object.keys(number_stories).length) {
            // alert("âš ï¸ æ•…äº‹æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            return false;
        }
        return true;
    }

    function checkPegs100Loaded() {
        if (!Object.keys(number_pegs100).length) {
            // alert("âš ï¸ 100æ¡©æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            return false;
        }
        return true;
    }

    /**
     * è·å–é€‰ä¸­çš„èŒƒå›´å¤é€‰æ¡†çš„å€¼
     * @param {string} name - å¤é€‰æ¡†ç»„çš„åç§° (e.g., 'multi-range')
     * @returns {string[]} é€‰ä¸­çš„å€¼æ•°ç»„ (e.g., ["100", "1000"])
     */
    function getSelectedRanges(name) {
        const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // ======================================================
    // é¡µé¢è·³è½¬é€»è¾‘
    // ======================================================
    function showMenuUI() {
        hideAllViews();
        views.menu.classList.add('active');
        const dataKeys = Object.keys(number_encodings).length;
        document.getElementById('data-status').textContent = `ç¼–ç : ${dataKeys > 0 ? `å·²åŠ è½½ (${dataKeys} æ¡)` : 'ç¼ºå¤±'}`;

        const storyKeys = Object.keys(number_stories).length;
        document.getElementById('story-status').textContent = `æ•…äº‹: ${storyKeys > 0 ? `å·²åŠ è½½ (${storyKeys} æ®µ)` : 'ç¼ºå¤±'}`;

        const pegs100Keys = Object.keys(number_pegs100).length;
        document.getElementById('pegs100-status').textContent = `100æ¡©: ${pegs100Keys > 0 ? `å·²åŠ è½½ (${pegs100Keys} æ¡)` : 'ç¼ºå¤±'}`;

        // å¦‚æœ100æ¡©ç¼ºå¤±ï¼Œç¦ç”¨å¯¹åº”èœå•é¡¹
        const pegs100MenuItem = document.querySelector('.pegs100-required');
        if (pegs100Keys === 0) {
            pegs100MenuItem.classList.add('disabled');
        } else {
            pegs100MenuItem.classList.remove('disabled');
        }
    }

    // 5. æ•…äº‹èœå•é¡µ
    function showStoryMenuUI() {
        if(!checkStoryLoaded()) return;
        hideAllViews();
        views.storyMenu.classList.add('active');
    }

    // 5. æ•…äº‹åˆ—è¡¨é¡µ
    function showStoryListUI() {
        if(!checkStoryLoaded()) return;
        hideAllViews();
        views.storyList.classList.add('active');
        generateStoryList();
    }

    function generateStoryList() {
        const listEl = document.getElementById('story-list-content');
        listEl.innerHTML = '';
        // å‡è®¾æ•…äº‹é”®æ˜¯ "100-109", "110-119", ..., "990-999"
        const keys = Object.keys(number_stories).sort();
        keys.forEach(key => {
            const li = document.createElement('li');
            li.className = 'story-list-item';
            li.textContent = key;
            li.onclick = () => viewStorySegment(key);
            listEl.appendChild(li);
        });
    }

    // 6. 100 æ¡©èœå•é¡µ
    function showPegs100MenuUI() {
        if(!checkPegs100Loaded()) return;
        hideAllViews();
        views.pegs100Menu.classList.add('active');
    }

    // 6. 100 æ¡©åˆ—è¡¨é¡µ
    function showPegs100ListUI() {
        if(!checkPegs100Loaded()) return;
        hideAllViews();
        views.pegs100List.classList.add('active');
        generatePegs100List();
    }

    function generatePegs100List() {
        const listEl = document.getElementById('pegs100-list-content');
        listEl.innerHTML = '';
        const numbers = Object.keys(number_pegs100).sort();
        let content = '';
        numbers.forEach(num => {
            content += `${num}: ${number_pegs100[num]}\n`;
        });
        listEl.textContent = content;
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šåŠŸèƒ½ 1 (å•æ¬¡éšæœºè®­ç»ƒ) - ç¼ºå¤±çš„ä»£ç å·²æ·»åŠ 
    // ======================================================

    // 1. å•æ¬¡è®­ç»ƒ - èŒƒå›´é¡µ
    function showDrillRangeUI() {
        if(!checkDataLoaded()) return;
        hideAllViews();
        views.drillRange.classList.add('active');
        document.getElementById('drill-min').value = lastDrillMin;
        document.getElementById('drill-max').value = lastDrillMax;
    }

    function handleDrillStart() {
        const min = parseInt(document.getElementById('drill-min').value);
        const max = parseInt(document.getElementById('drill-max').value);
        if (isNaN(min) || isNaN(max) || min > max) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„èŒƒå›´");
            return;
        }
        lastDrillMin = min;
        lastDrillMax = max;
        runDrillLogic(min, max);
    }

    function runDrillLogic(min, max) {
        const target = generateRandomNumber(min, max);
        const answer = getEncoding(target);

        setTimeout(() => {
            const conf = confirm(`ğŸ§  éšæœºæ•°å­—: ${target}\n(èŒƒå›´ ${min.toString().padStart(3, '0')}-${max.toString().padStart(3, '0')})\n\nè¯·è”æƒ³...\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹ç­”æ¡ˆã€‚`);
            if(conf) {
                showResult(`âœ… ${target} çš„ç¼–ç `, `æ•°å­—: ${target}\nç¼–ç : ${answer}`, () => {
                    // ç»­æ¯é€»è¾‘ï¼šé‡æ–°è¯»å–ç»“æœé¡µé¢çš„è®¾ç½®æ¡†
                    const newMin = parseInt(document.getElementById('next-min-input').value);
                    const newMax = parseInt(document.getElementById('next-max-input').value);
                    // ç®€å•æ£€æŸ¥æœ‰æ•ˆæ€§
                    if (!isNaN(newMin) && !isNaN(newMax) && newMin <= newMax) {
                        lastDrillMin = newMin;
                        lastDrillMax = newMax;
                        runDrillLogic(newMin, newMax);
                    } else {
                        // å¦‚æœè®¾ç½®æ— æ•ˆï¼Œå°±ç”¨ä¸Šæ¬¡çš„èŒƒå›´ç»§ç»­
                        runDrillLogic(lastDrillMin, lastDrillMax);
                    }
                });
                // æ˜¾ç¤ºå•æ¬¡è®­ç»ƒä¸“ç”¨çš„è®¾ç½®æ 
                document.getElementById('result-setting-bar').style.display = 'block';
                document.getElementById('setting-single-content').style.display = 'flex';
                document.getElementById('setting-multi-content').style.display = 'none';
                document.getElementById('next-min-input').value = min;
                document.getElementById('next-max-input').value = max;
                document.getElementById('result-next-btn').textContent = "ç»§ç»­æ­¤èŒƒå›´è®­ç»ƒ";
                // å•æ¬¡è®­ç»ƒä¸éœ€è¦æŸ¥çœ‹ä¸‹ä¸€ä¸ªæŒ‰é’®ï¼Œä¿æŒéšè—
                document.getElementById('result-view-next-btn').style.display = 'none';
            } else {
                showMenuUI();
            }
        }, 50);
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šåŠŸèƒ½ 2 (é»˜å†™æµ‹è¯•) - ç¼ºå¤±çš„ä»£ç å·²æ·»åŠ 
    // ======================================================

    // 2. é»˜å†™æµ‹è¯• - èŒƒå›´é¡µ (ç‹¬ç«‹)
    function showQuizRangeUI() {
        if(!checkDataLoaded()) return;
        hideAllViews();
        views.quizRange.classList.add('active');
        document.getElementById('quiz-min-setup').value = lastQuizMin;
        document.getElementById('quiz-max-setup').value = lastQuizMax;
    }

    function handleQuizStart() {
        const min = parseInt(document.getElementById('quiz-min-setup').value);
        const max = parseInt(document.getElementById('quiz-max-setup').value);
        if (isNaN(min) || isNaN(max) || min > max) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆçš„èŒƒå›´");
            return;
        }
        // ä¿å­˜çŠ¶æ€
        lastQuizMin = min;
        lastQuizMax = max;
        // è¿›å…¥æµ‹è¯•é¡µ
        hideAllViews();
        views.quizWork.classList.add('active');
        nextQuizRound();
    }

    function nextQuizRound() {
        currentQuizTargetNum = generateRandomNumber(lastQuizMin, lastQuizMax);
        // UI é‡ç½®
        document.getElementById('quiz-question-num').textContent = currentQuizTargetNum;
        document.getElementById('quiz-range-label').textContent = `${lastQuizMin.toString().padStart(3, '0')} - ${lastQuizMax.toString().padStart(3, '0')}`;
        document.getElementById('quiz-answer-input').value = "";
        document.getElementById('quiz-answer-input').focus();
        document.getElementById('quiz-result-box').style.display = 'none';
        document.getElementById('quiz-submit-btn').style.display = 'block';
        document.getElementById('quiz-next-btn').style.display = 'none';
    }

    function checkQuizAnswer() {
        const answer = document.getElementById('quiz-answer-input').value.trim();
        if (!answer) return;

        const correct = getEncoding(currentQuizTargetNum);
        const isCorrect = answer === correct;
        const resultBox = document.getElementById('quiz-result-box');

        resultBox.classList.remove('quiz-correct', 'quiz-wrong');
        resultBox.style.display = 'block';

        if (isCorrect) {
            resultBox.classList.add('quiz-correct');
            resultBox.innerHTML = `âœ… **å›ç­”æ­£ç¡®!**\n\næ•°å­—: ${currentQuizTargetNum}\nç¼–ç : ${correct}`;
        } else {
            resultBox.classList.add('quiz-wrong');
            resultBox.innerHTML = `âŒ **å›ç­”é”™è¯¯!**\n\næ‚¨è¾“å…¥: ${answer}\næ­£ç¡®ç­”æ¡ˆ: ${correct}`;
        }

        document.getElementById('quiz-submit-btn').style.display = 'none';
        document.getElementById('quiz-next-btn').style.display = 'block';
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šå¤šé‡è®°å¿† (Multi) - ä¿ç•™äº†ä¹‹å‰ä¿®æ”¹çš„åŠŸèƒ½3ä»£ç 
    // ======================================================

    // 3/4/5/6. é€šç”¨è¾“å…¥é¡µ (å¤šé‡/æŸ¥è¯¢/æ•…äº‹æŸ¥è¯¢/100æ¡©æŸ¥è¯¢)
    function showInputPage(type) {
        // æ£€æŸ¥æ ¸å¿ƒæ•°æ®åŠ è½½çŠ¶æ€
        if(type === 'query' && !checkDataLoaded()) {
            alert("1000æ¡©æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
            showMenuUI();
            return;
        }
        if(type === 'storyQuery' && !checkStoryLoaded()) {
            alert("æ•…äº‹æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
            showMenuUI();
            return;
        }
        if(type === 'pegs100Query' && !checkPegs100Loaded()) {
            alert("100æ¡©æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
            showMenuUI();
            return;
        }

        currentPageType = type;
        hideAllViews();
        views.input.classList.add('active');
        const field = document.getElementById('input-field');
        const title = document.getElementById('input-page-title');
        const multiOptions = document.getElementById('multi-options');

        field.value = "";
        field.focus();

        // å¤„ç†å¤šé‡è®°å¿†é€‰é¡¹çš„æ˜¾ç¤ºå’ŒçŠ¶æ€
        if (type === 'multi') {
            title.textContent = "å¤šé‡è®°å¿† - è¾“å…¥æ•°é‡";
            field.placeholder = "è¯·è¾“å…¥ 1-20";
            multiOptions.style.display = 'block'; // æ˜¾ç¤ºé€‰é¡¹

            const pegs100Loaded = checkPegs100Loaded();
            const pegs1000Loaded = checkDataLoaded();

            // ç¦ç”¨å’Œé»˜è®¤é€‰ä¸­çŠ¶æ€
            const cb100 = document.getElementById('multi-range-100');
            const cb1000 = document.getElementById('multi-range-1000');
            cb100.disabled = !pegs100Loaded;
            cb1000.disabled = !pegs1000Loaded;

            // é»˜è®¤é€‰ä¸­æ‰€æœ‰å¯ç”¨çš„
            cb100.checked = pegs100Loaded;
            cb1000.checked = pegs1000Loaded;

            // å¦‚æœä¸¤ä¸ªéƒ½æ²¡åŠ è½½ï¼Œåˆ™é€€å‡º
            if (!pegs100Loaded && !pegs1000Loaded) {
                alert("å¤šé‡è®°å¿†æ‰€éœ€æ•°æ®ï¼ˆ100æ¡©/1000æ¡©ï¼‰å‡æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ¸…é™¤ç¼“å­˜ã€‚");
                showMenuUI();
                return;
            }
        } else {
            // å…¶ä»–ç±»å‹
            multiOptions.style.display = 'none'; // éšè—é€‰é¡¹
            if (type === 'query') {
                title.textContent = "æŸ¥è¯¢ç¼–ç  - è¾“å…¥æ•°å­—";
                field.placeholder = "è¯·è¾“å…¥æ•°å­— (000-999)";
            } else if (type === 'storyQuery') {
                title.textContent = "æŸ¥è¯¢æ•…äº‹ - è¾“å…¥æ•°å­—";
                field.placeholder = "è¯·è¾“å…¥æ•°å­— (100-999)";
            } else if (type === 'pegs100Query') {
                title.textContent = "æŸ¥è¯¢ 100 æ¡© - è¾“å…¥æ•°å­—";
                field.placeholder = "è¯·è¾“å…¥æ•°å­— (00-99)";
            }
        }
        validateInput(); // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
    }

    function runMultiLogic(N) {
        const selectedRanges = getSelectedRanges('multi-range');

        if (selectedRanges.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•°å­—æ¡©èŒƒå›´è¿›è¡Œè®­ç»ƒã€‚");
            showInputPage('multi'); // è¿”å›è¾“å…¥é¡µ
            return;
        }

        // 1. ç¡®å®šå±•ç¤ºæ ‡é¢˜ä¸­çš„èŒƒå›´
        let titleRange = "";
        if (selectedRanges.length === 2) {
            titleRange = "00-999";
        } else if (selectedRanges.includes('100')) {
            titleRange = "00-99";
        } else if (selectedRanges.includes('1000')) {
            titleRange = "100-999";
        }

        // 2. ç”Ÿæˆ N ä¸ªæ•°å­—ï¼Œéšæœºä»é€‰å®šçš„èŒƒå›´ä¸­æŠ½å–
        const numbers = [];
        for (let i = 0; i < N; i++) {
            // éšæœºé€‰æ‹©ä¸€ä¸ªèŒƒå›´
            const rangeChoice = selectedRanges[Math.floor(Math.random() * selectedRanges.length)];
            let num;
            if (rangeChoice === '100') {
                num = generateRandomNumber(0, 99);
            } else { // '1000'
                num = generateRandomNumber(DEFAULT_MIN, DEFAULT_MAX);
            }
            numbers.push({num: num, range: rangeChoice}); // å­˜å‚¨æ•°å­—å’Œå®ƒçš„èŒƒå›´ç±»å‹
        }

        // 3. ç”Ÿæˆå±•ç¤ºå­—ç¬¦ä¸²
        const listStr = numbers.map(item => item.num.padStart(item.range === '100' ? 2 : 3, '0')).join(', ');

        const answerStr = numbers.map(item => {
            const numDisplay = item.num.padStart(item.range === '100' ? 2 : 3, '0');
            const peg = item.range === '100' ? getPeg100(item.num) : getEncoding(item.num);
            return `${numDisplay}: ${peg}`;
        }).join('\n');


        setTimeout(() => {
            const conf = confirm(`è®°å¿† ${N} ä¸ªæ•°å­— (èŒƒå›´: ${titleRange}):\n${listStr}\n\nå‡†å¤‡å¥½æŸ¥çœ‹ç­”æ¡ˆå—ï¼Ÿ`);
            if(conf) {
                showResult("âœ… å¤šé‡è®°å¿†ç­”æ¡ˆ", `**æ•°å­— (èŒƒå›´: ${titleRange}):**\n${answerStr}`, () => {
                    // å›è°ƒé€»è¾‘å·²ç§»è‡³ handleResultNextï¼Œè¿™é‡Œç•™ç©ºæˆ–ä¸ä¼ 
                });

                // ç»“æœé¡µè®¾ç½®æ é…ç½®
                document.getElementById('result-setting-bar').style.display = 'block';
                document.getElementById('setting-single-content').style.display = 'none';
                document.getElementById('setting-multi-content').style.display = 'flex';
                document.getElementById('next-count-input').value = N;
                document.getElementById('result-next-btn').textContent = "ç»§ç»­ä¸‹ä¸€ç»„æ•°å­—";
                document.getElementById('result-view-next-btn').style.display = 'none';

                // è®¾ç½®ä¸‹ä¸€è½®çš„èŒƒå›´å¤é€‰æ¡†
                const cbNext100 = document.getElementById('next-multi-range-100');
                const cbNext1000 = document.getElementById('next-multi-range-1000');
                cbNext100.checked = selectedRanges.includes('100');
                cbNext1000.checked = selectedRanges.includes('1000');
                // ç¦ç”¨ä¸‹ä¸€è½®é€‰é¡¹å¦‚æœæ•°æ®æœªåŠ è½½
                cbNext100.disabled = !checkPegs100Loaded();
                cbNext1000.disabled = !checkDataLoaded();

            } else {
                showMenuUI();
            }
        }, 50);
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šæŸ¥è¯¢ç¼–ç  (Query)
    // ======================================================

    function runQueryLogic(numStr) {
        const num = parseInt(numStr);
        const paddedNumStr = String(num).padStart(3, '0');

        if (isNaN(num) || num < 0 || num > 999) {
            alert("è¯·è¾“å…¥ 000-999 èŒƒå›´å†…çš„æœ‰æ•ˆæ•°å­—");
            return;
        }

        const encoding = getEncoding(paddedNumStr);
        showResult(`ğŸ” æŸ¥è¯¢ç¼–ç : ${paddedNumStr}`, `ç¼–ç : ${encoding}`, () => showInputPage('query'));
        document.getElementById('result-next-btn').textContent = "ç»§ç»­æŸ¥è¯¢";
        document.getElementById('result-view-next-btn').style.display = 'block';
        currentQueryNumber = num;
        currentPageType = 'query';
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šæ•…äº‹ç›¸å…³ (Story)
    // ======================================================
    function showRandomStory() {
        if(!checkStoryLoaded()) return;

        // éšæœºä¸€ä¸ª 100-999 çš„æ•°å­—æ¡©
        const randomNum = generateRandomNumber(100, 999);
        const randomNumStr = String(randomNum).padStart(3, '0');

        // æ˜¾ç¤ºæ•…äº‹
        const storyContent = getStory(randomNumStr);
        showResult(`ğŸ² éšæœºæ•…äº‹: ${randomNumStr}`, storyContent, showRandomStory);
        document.getElementById('result-next-btn').textContent = "å†æ¥ä¸€ä¸ªéšæœºæ•…äº‹";
    }

    function viewStorySegment(key) {
        const storyText = number_stories[key] || `[æ•…äº‹æ®µè½ ${key} ç¼ºå¤±]`;
        // æ˜¾ç¤ºç»“æœæ—¶ï¼Œéœ€è¦å°† (æ•°å­—) æ¨¡å¼æ›¿æ¢ä¸º **(æ•°å­—)** çªå‡ºæ˜¾ç¤º
        const formattedText = storyText.replace(/\((\d{3})\)/g, '($1)').replace(/(\(\d{3}\))/g, ' **$1** ');
        showResult(`ğŸ“˜ ${key} æ•…äº‹æ®µè½`, formattedText, () => showStoryListUI());
        document.getElementById('result-next-btn').textContent = "è¿”å›æ•…äº‹åˆ—è¡¨";
    }

    function handleStoryQuery(numStr) {
        const num = parseInt(numStr);
        const paddedNumStr = String(num).padStart(3, '0');

        if (isNaN(num) || num < 100 || num > 999) {
            alert("è¯·è¾“å…¥ 100-999 èŒƒå›´å†…çš„æœ‰æ•ˆæ•°å­—");
            return;
        }

        const storyContent = getStory(paddedNumStr);
        showResult(`ğŸ” æŸ¥è¯¢æ•…äº‹: ${paddedNumStr}`, storyContent, () => showInputPage('storyQuery'));
        document.getElementById('result-next-btn').textContent = "ç»§ç»­æŸ¥è¯¢";
        document.getElementById('result-view-next-btn').style.display = 'block'; // å…è®¸æŸ¥çœ‹ä¸‹ä¸€ä¸ª
        currentQueryNumber = num; // è®¾ç½®å½“å‰æŸ¥è¯¢æ•°å­—ï¼Œæ–¹ä¾¿æŸ¥çœ‹ä¸‹ä¸€ä¸ª
        currentPageType = 'storyQuery'; // ç¡®ä¿ handleViewNext çŸ¥é“å½“å‰æ¨¡å¼
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼š100 æ¡©ç›¸å…³ (Pegs100)
    // ======================================================
    function showRandomPeg100() {
        if(!checkPegs100Loaded()) return;

        // éšæœºä¸€ä¸ª 00-99 çš„æ•°å­—æ¡©
        const randomNum = generateRandomNumber(0, 99);
        const randomNumStr = String(randomNum).padStart(2, '0');

        // æ˜¾ç¤ºæ¡©å­
        const pegContent = getPeg100(randomNumStr);
        showResult(`ğŸ² éšæœº 100 æ¡©: ${randomNumStr}`, `æ¡©å­: ${pegContent}`, showRandomPeg100);
        document.getElementById('result-next-btn').textContent = "å†æ¥ä¸€ä¸ªéšæœºæ¡©å­";
    }

    function handlePegs100Query(numStr) {
        const num = parseInt(numStr);
        const paddedNumStr = String(num).padStart(2, '0');

        if (isNaN(num) || num < 0 || num > 99) {
            alert("è¯·è¾“å…¥ 00-99 èŒƒå›´å†…çš„æœ‰æ•ˆæ•°å­—");
            return;
        }

        const pegContent = getPeg100(paddedNumStr);
        showResult(`ğŸ” æŸ¥è¯¢ 100 æ¡©: ${paddedNumStr}`, `æ¡©å­: ${pegContent}`, () => showInputPage('pegs100Query'));
        document.getElementById('result-next-btn').textContent = "ç»§ç»­æŸ¥è¯¢";
        document.getElementById('result-view-next-btn').style.display = 'block';
        currentQueryNumber = num;
        currentPageType = 'pegs100Query';
    }

    // ======================================================
    // ä¸šåŠ¡é€»è¾‘ï¼šé€šç”¨å¤„ç† (Input/Result/Data)
    // ======================================================

    function validateInput() {
        const val = document.getElementById('input-field').value;
        document.getElementById('input-submit-btn').disabled = (val.trim() === "");
    }

    function handleInputSubmit() {
        const val = document.getElementById('input-field').value.trim();
        if (!val) return;

        if (currentPageType === 'multi') {
            const n = parseInt(val);
            if (n > 0 && n <= 20) {
                currentMultiCount = n;
                runMultiLogic(n);
            } else {
                alert("è¯·è¾“å…¥ 1-20");
            }
        } else if (currentPageType === 'query') {
            // æŸ¥è¯¢ç¼–ç 
            if (!/^\d+$/.test(val)) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (000-999)");
                return;
            }
            runQueryLogic(val);
        } else if (currentPageType === 'storyQuery') {
            // æŸ¥è¯¢æ•…äº‹
            if (!/^\d+$/.test(val) || parseInt(val) < 100 || parseInt(val) > 999) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (100-999)");
                return;
            }
            handleStoryQuery(val);
        } else if (currentPageType === 'pegs100Query') {
            // æŸ¥è¯¢ 100 æ¡©
            if (!/^\d+$/.test(val) || parseInt(val) < 0 || parseInt(val) > 99) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (00-99)");
                return;
            }
            handlePegs100Query(val);
        }
    }

    function showResult(title, text, nextCallback) {
        hideAllViews();
        views.result.classList.add('active');
        document.getElementById('result-page-title').textContent = title;
        document.getElementById('result-page-content').innerHTML = text; // ä½¿ç”¨ innerHTML æ”¯æŒåŠ ç²—
        document.getElementById('result-view-next-btn').style.display = 'none'; // reset

        nextActionCallback = nextCallback;
        const btn = document.getElementById('result-next-btn');
        if (nextCallback || currentPageType === 'multi') {
            btn.style.display = 'block';
            btn.textContent = "ç»§ç»­æ­¤é¡¹æ“ä½œ"; // é»˜è®¤æ–‡æœ¬
        } else {
            btn.style.display = 'none';
        }
    }

    function handleResultNext() {
        if (currentPageType === 'multi') {
            const nextN = parseInt(document.getElementById('next-count-input').value);
            const nextSelectedRanges = getSelectedRanges('next-multi-range');

            if (isNaN(nextN) || nextN <= 0 || nextN > 20) {
                alert("è¯·æ£€æŸ¥ä¸‹ä¸€è½®æ•°é‡è®¾ç½®ï¼Œå¿…é¡»åœ¨ 1-20 ä¹‹é—´ã€‚");
                return;
            }

            if (nextSelectedRanges.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•°å­—æ¡©èŒƒå›´ã€‚");
                return;
            }

            // å°†ä¸‹ä¸€è½®çš„è®¾ç½®ä½œä¸ºå½“å‰è®¾ç½®
            const cb100 = document.getElementById('multi-range-100');
            const cb1000 = document.getElementById('multi-range-1000');
            cb100.checked = nextSelectedRanges.includes('100');
            cb1000.checked = nextSelectedRanges.includes('1000');

            currentMultiCount = nextN;
            runMultiLogic(nextN);
        } else if(nextActionCallback) {
            nextActionCallback();
        } else {
            showMenuUI();
        }
    }

    function handleViewNext() {
        if (currentQueryNumber === null) return;
        const nextNum = currentQueryNumber + 1;

        if (currentPageType === 'query') {
            // ç¼–ç æŸ¥è¯¢ (000-999)
            if (nextNum > 999) {
                alert("å·²åˆ°è¾¾ 999ï¼Œæ— æ³•æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ•°å­—ã€‚");
                return;
            }
            runQueryLogic(String(nextNum));
        } else if (currentPageType === 'storyQuery') {
            // æ•…äº‹æŸ¥è¯¢ (100-999)
            if (nextNum > 999) {
                alert("å·²åˆ°è¾¾ 999ï¼Œæ— æ³•æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ•°å­—ã€‚");
                return;
            }
            handleStoryQuery(String(nextNum));
        } else if (currentPageType === 'pegs100Query') {
            // 100æ¡©æŸ¥è¯¢ (00-99)
            if (nextNum > 99) {
                alert("å·²åˆ°è¾¾ 99ï¼Œæ— æ³•æŸ¥è¯¢ä¸‹ä¸€ä¸ªæ•°å­—ã€‚");
                return;
            }
            handlePegs100Query(String(nextNum));
        }
    }

    // ======================================================
    // æ•°æ®åŠ è½½ä¸åˆå§‹åŒ–
    // ======================================================

    async function fetchJsonData(url, cacheKey, dataVar, statusId, displayName) {
        const statusEl = document.getElementById(statusId);
        let dataKeys = 0;

        // 1. å°è¯•æœ¬åœ°ç¼“å­˜
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            try {
                Object.assign(dataVar, JSON.parse(cachedData));
                dataKeys = Object.keys(dataVar).length;
                statusEl.textContent = `${displayName}: å·²åŠ è½½ (ç¼“å­˜, ${dataKeys} æ¡)`;
                console.log(`Loaded ${displayName} from cache`);
                return true;
            } catch(e) {
                localStorage.removeItem(cacheKey);
            }
        }

        // 2. å°è¯•ç½‘ç»œåŠ è½½
        try {
            statusEl.textContent = `${displayName}: æ›´æ–°ä¸­...`;
            const res = await fetch(url);
            const json = await res.json();
            Object.assign(dataVar, json);
            localStorage.setItem(cacheKey, JSON.stringify(json));
            dataKeys = Object.keys(json).length;
            statusEl.textContent = `${displayName}: å·²åŠ è½½ (${dataKeys} æ¡)`;
            console.log(`Loaded ${displayName} from network`);
            return true;
        } catch(e) {
            console.error(`Failed to load ${displayName} data:`, e);
            const statusText = dataKeys > 0 ? `å·²åŠ è½½ (ç¼“å­˜, ${dataKeys} æ¡)` : "åŠ è½½å¤±è´¥";
            statusEl.textContent = `${displayName}: ${statusText}`;
            return false;
        }
    }

    async function initData() {
        // å¼‚æ­¥å¹¶è¡ŒåŠ è½½
        await Promise.all([
            fetchJsonData(JSON_URL, CACHE_KEY, number_encodings, 'data-status', 'ç¼–ç '),
            fetchJsonData(STORY_URL, STORY_CACHE_KEY, number_stories, 'story-status', 'æ•…äº‹'),
            fetchJsonData(CODE100_URL, CODE100_CACHE_KEY, number_pegs100, 'pegs100-status', '100æ¡©')
        ]);

        // ç¡®ä¿æ›´æ–°çŠ¶æ€åå†æ¬¡åˆ·æ–°èœå•
        showMenuUI();
    }

    function clearCacheAndReload() {
        const confirmed = confirm("ç¡®å®šè¦æ¸…é™¤æœ¬åœ°ç¼“å­˜å¹¶é‡æ–°ä¸‹è½½æ‰€æœ‰æ•°æ®å—ï¼Ÿï¼ˆç”¨äºæ•°æ®æ›´æ–°ï¼‰");
        if (confirmed) {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(STORY_CACHE_KEY);
            localStorage.removeItem(CODE100_CACHE_KEY); // æ–°å¢æ¸…é™¤ 100 æ¡©ç¼“å­˜
            number_encodings = {};
            number_stories = {};
            number_pegs100 = {}; // æ¸…ç©º 100 æ¡©æ•°æ®
            document.getElementById('data-status').textContent = "ç¼–ç : ç¼“å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...";
            document.getElementById('story-status').textContent = "æ•…äº‹: ç¼“å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...";
            document.getElementById('pegs100-status').textContent = "100æ¡©: ç¼“å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...";
            initData(); // é‡æ–°åŠ è½½æ•°æ®
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåï¼Œåˆå§‹åŒ–æ•°æ®
    document.addEventListener('DOMContentLoaded', initData);
</script>
</body>
</html>
